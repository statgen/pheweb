!function(e,a){"function"==typeof define&&define.amd?define(["d3"],function(t){return e.LocusZoom=a(t)}):"object"==typeof module&&module.exports?module.exports=e.LocusZoom=a(require("d3")):e.LocusZoom=a(e.d3)}(this,function(t){var e,a;try{var i="3.5.6";if("object"!=typeof t)throw new Error("d3 dependency not met. Library missing.");if(!function(t,e){if(e==t)return!0;var a=t.split("."),i=e.split("."),s=!1;return a.forEach(function(t,e){!s&&+i[e]>+a[e]&&(s=!0)}),s}(i,t.version))throw new Error("d3 dependency not met. Outdated version detected.\nRequired d3 version: 3.5.6 or higher (found: "+t.version+").");e=this,a=function(g){var a,i,s,n,o,r,l,e,h,u,d,c,t,p,y,_,f,m,b,v,x,w,D;try{var z="3.5.6";if("object"!=typeof g)throw new Error("d3 dependency not met. Library missing.");if(!function(t,e){if(e==t)return!0;var a=t.split("."),i=e.split("."),s=!1;return a.forEach(function(t,e){!s&&+i[e]>+a[e]&&(s=!0)}),s}(z,g.version))throw new Error("d3 dependency not met. Outdated version detected.\nRequired d3 version: 3.5.6 or higher (found: "+g.version+").");var L={version:"0.11.0",populate:function(t,a,i){if(void 0===t)throw new Error("LocusZoom.populate selector not defined");var s;return g.select(t).html(""),g.select(t).call(function(){if(void 0===this.node().id){for(var t=0;!g.select("#lz-"+t).empty();)t++;this.attr("id","#lz-"+t)}if((s=new L.Plot(this.node().id,a,i)).container=this.node(),void 0!==this.node().dataset&&void 0!==this.node().dataset.region){var e=L.parsePositionQuery(this.node().dataset.region);Object.keys(e).forEach(function(t){s.state[t]=e[t]})}s.svg=g.select("div#"+s.id).append("svg").attr("version","1.1").attr("xmlns","http://www.w3.org/2000/svg").attr("id",s.id+"_svg").attr("class","lz-locuszoom").style(s.layout.style),s.setDimensions(),s.positionPanels(),s.initialize(),"object"==typeof a&&Object.keys(a).length&&s.refresh()}),s},populateAll:function(t,a,i){var s=[];return g.selectAll(t).each(function(t,e){s[e]=L.populate(this,a,i)}),s},positionIntToString:function(t,e,a){var i={0:"",3:"K",6:"M",9:"G"};if(a=a||!1,isNaN(e)||null===e){var s=Math.log(t)/Math.LN10;e=Math.min(Math.max(s-s%3,0),9)}var n=e-Math.floor((Math.log(t)/Math.LN10).toFixed(e+3)),o=Math.min(Math.max(e,0),2),r=Math.min(Math.max(n,o),12),l=""+(t/Math.pow(10,e)).toFixed(r);return a&&void 0!==i[e]&&(l+=" "+i[e]+"b"),l},positionStringToInt:function(t){var e=t.toUpperCase();e=e.replace(/,/g,"");var a=/([KMG])[B]*$/,i=a.exec(e),s=1;return i&&(s="M"===i[1]?1e6:"G"===i[1]?1e9:1e3,e=e.replace(a,"")),e=Number(e)*s},parsePositionQuery:function(t){var e=/^(\w+):([\d,.]+[kmgbKMGB]*)([-+])([\d,.]+[kmgbKMGB]*)$/.exec(t);if(e){if("+"===e[3]){var a=L.positionStringToInt(e[2]),i=L.positionStringToInt(e[4]);return{chr:e[1],start:a-i,end:a+i}}return{chr:e[1],start:L.positionStringToInt(e[2]),end:L.positionStringToInt(e[4])}}return(e=/^(\w+):([\d,.]+[kmgbKMGB]*)$/.exec(t))?{chr:e[1],position:L.positionStringToInt(e[2])}:null},prettyTicks:function(t,e,a){(void 0===a||isNaN(parseInt(a)))&&(a=5);var i=(a=parseInt(a))/3,s=Math.abs(t[0]-t[1]),n=s/a;Math.log(s)/Math.LN10<-2&&(n=.75*Math.max(Math.abs(s))/i);var o=Math.pow(10,Math.floor(Math.log(n)/Math.LN10)),r=0;o<1&&0!==o&&(r=Math.abs(Math.round(Math.log(o)/Math.LN10)));var l=o;2*o-n<1.5*(n-l)&&5*o-n<2.75*(n-(l=2*o))&&10*o-n<1.5*(n-(l=5*o))&&(l=10*o);for(var h=[],u=parseFloat((Math.floor(t[0]/l)*l).toFixed(r));u<t[1];)h.push(u),u+=l,0<r&&(u=parseFloat(u.toFixed(r)));return h.push(u),void 0!==e&&-1!==["low","high","both","neither"].indexOf(e)||(e="neither"),"low"!==e&&"both"!==e||h[0]<t[0]&&(h=h.slice(1)),"high"!==e&&"both"!==e||h[h.length-1]>t[1]&&h.pop(),h},createCORSPromise:function(s,n,o,r,l){return new Promise(function(t,e){var a=new XMLHttpRequest;if("withCredentials"in a?a.open(s,n,!0):"undefined"!=typeof XDomainRequest?(a=new XDomainRequest).open(s,n):a=null,a){if(a.onreadystatechange=function(){4===a.readyState&&(200===a.status||0===a.status?t(a.response):e("HTTP "+a.status+" for "+n))},l&&setTimeout(e,l),o=void 0!==o?o:"",void 0!==r)for(var i in r)a.setRequestHeader(i,r[i]);a.send(o)}})},_updateStatePosition:function(t,e){e=e||{};var a=!1;if(void 0!==(t=t||{}).chr&&void 0!==t.start&&void 0!==t.end){var i,s=null;if(t.start=Math.max(parseInt(t.start),1),t.end=Math.max(parseInt(t.end),1),isNaN(t.start)&&isNaN(t.end))t.start=1,t.end=1,s=.5,i=0;else if(isNaN(t.start)||isNaN(t.end))s=t.start||t.end,i=0,t.start=isNaN(t.start)?t.end:t.start,t.end=isNaN(t.end)?t.start:t.end;else{if(s=Math.round((t.start+t.end)/2),(i=t.end-t.start)<0){var n=t.start;t.end=t.start,t.start=n,i=t.end-t.start}s<0&&(t.start=1,t.end=1,i=0)}a=!0}return!isNaN(e.min_region_scale)&&a&&i<e.min_region_scale&&(t.start=Math.max(s-Math.floor(e.min_region_scale/2),1),t.end=t.start+e.min_region_scale),!isNaN(e.max_region_scale)&&a&&i>e.max_region_scale&&(t.start=Math.max(s-Math.floor(e.max_region_scale/2),1),t.end=t.start+e.max_region_scale),t},parseFields:function(e,t){if("object"!=typeof e)throw new Error("LocusZoom.parseFields invalid arguments: data is not an object");if("string"!=typeof t)throw new Error("LocusZoom.parseFields invalid arguments: html is not a string");for(var a=[],i=/\{\{(?:(#if )?([A-Za-z0-9_:|]+)|(\/if))\}\}/;0<t.length;){var s=i.exec(t);s?0!==s.index?(a.push({text:t.slice(0,s.index)}),t=t.slice(s.index)):("#if "===s[1]?a.push({condition:s[2]}):s[2]?a.push({variable:s[2]}):"/if"===s[3]?a.push({close:"if"}):console.error("Error tokenizing tooltip when remaining template is "+JSON.stringify(t)+" and previous tokens are "+JSON.stringify(a)+" and current regex match is "+JSON.stringify([s[1],s[2],s[3]])),t=t.slice(s[0].length)):(a.push({text:t}),t="")}for(var n=function(){var t=a.shift();if(void 0!==t.text||t.variable)return t;if(t.condition){for(t.then=[];0<a.length;){if("if"===a[0].close){a.shift();break}t.then.push(n())}return t}return console.error("Error making tooltip AST due to unknown token "+JSON.stringify(t)),{text:""}},o=[];0<a.length;)o.push(n());var r=function(t){return r.cache.hasOwnProperty(t)||(r.cache[t]=new L.Data.Field(t).resolve(e)),r.cache[t]};r.cache={};var l=function(e){if(void 0!==e.text)return e.text;if(e.variable){try{var t=r(e.variable);if(-1!==["string","number","boolean"].indexOf(typeof t))return t;if(null===t)return""}catch(t){console.error("Error while processing variable "+JSON.stringify(e.variable))}return"{{"+e.variable+"}}"}if(e.condition){try{var a=r(e.condition);if(a||0===a)return e.then.map(l).join("")}catch(t){console.error("Error while processing condition "+JSON.stringify(e.variable))}return""}console.error("Error rendering tooltip due to unknown AST node "+JSON.stringify(e))};return o.map(l).join("")},getToolTipData:function(t){if("object"!=typeof t||void 0===t.parentNode)throw new Error("Invalid node object");var e=g.select(t);return e.classed("lz-data_layer-tooltip")&&void 0!==e.data()[0]?e.data()[0]:L.getToolTipData(t.parentNode)},getToolTipDataLayer:function(t){var e=L.getToolTipData(t);return e.getDataLayer?e.getDataLayer():null},getToolTipPanel:function(t){var e=L.getToolTipDataLayer(t);return e?e.parent:null},getToolTipPlot:function(t){var e=L.getToolTipPanel(t);return e?e.parent:null},generateCurtain:function(){return{showing:!1,selector:null,content_selector:null,hide_delay:null,show:function(t,e){return this.curtain.showing||(this.curtain.selector=g.select(this.parent_plot.svg.node().parentNode).insert("div").attr("class","lz-curtain").attr("id",this.id+".curtain"),this.curtain.content_selector=this.curtain.selector.append("div").attr("class","lz-curtain-content"),this.curtain.selector.append("div").attr("class","lz-curtain-dismiss").html("Dismiss").on("click",function(){this.curtain.hide()}.bind(this)),this.curtain.showing=!0),this.curtain.update(t,e)}.bind(this),update:function(t,e){if(!this.curtain.showing)return this.curtain;clearTimeout(this.curtain.hide_delay),"object"==typeof e&&this.curtain.selector.style(e);var a=this.getPageOrigin();return this.curtain.selector.style({top:a.y+"px",left:a.x+"px",width:this.layout.width+"px",height:this.layout.height+"px"}),this.curtain.content_selector.style({"max-width":this.layout.width-40+"px","max-height":this.layout.height-40+"px"}),"string"==typeof t&&this.curtain.content_selector.html(t),this.curtain}.bind(this),hide:function(t){return this.curtain.showing&&("number"==typeof t?(clearTimeout(this.curtain.hide_delay),this.curtain.hide_delay=setTimeout(this.curtain.hide,t)):(this.curtain.selector.remove(),this.curtain.selector=null,this.curtain.content_selector=null,this.curtain.showing=!1)),this.curtain}.bind(this)}},generateLoader:function(){return{showing:!1,selector:null,content_selector:null,progress_selector:null,cancel_selector:null,show:function(t){return this.loader.showing||(this.loader.selector=g.select(this.parent_plot.svg.node().parentNode).insert("div").attr("class","lz-loader").attr("id",this.id+".loader"),this.loader.content_selector=this.loader.selector.append("div").attr("class","lz-loader-content"),this.loader.progress_selector=this.loader.selector.append("div").attr("class","lz-loader-progress-container").append("div").attr("class","lz-loader-progress"),this.loader.showing=!0,void 0===t&&(t="Loading...")),this.loader.update(t)}.bind(this),update:function(t,e){if(!this.loader.showing)return this.loader;clearTimeout(this.loader.hide_delay),"string"==typeof t&&this.loader.content_selector.html(t);var a=this.getPageOrigin(),i=this.loader.selector.node().getBoundingClientRect();return this.loader.selector.style({top:a.y+this.layout.height-i.height-6+"px",left:a.x+6+"px"}),"number"==typeof e&&this.loader.progress_selector.style({width:Math.min(Math.max(e,1),100)+"%"}),this.loader}.bind(this),animate:function(){return this.loader.progress_selector.classed("lz-loader-progress-animated",!0),this.loader}.bind(this),setPercentCompleted:function(t){return this.loader.progress_selector.classed("lz-loader-progress-animated",!1),this.loader.update(null,t)}.bind(this),hide:function(t){return this.loader.showing&&("number"==typeof t?(clearTimeout(this.loader.hide_delay),this.loader.hide_delay=setTimeout(this.loader.hide,t)):(this.loader.selector.remove(),this.loader.selector=null,this.loader.content_selector=null,this.loader.progress_selector=null,this.loader.cancel_selector=null,this.loader.showing=!1)),this.loader}.bind(this)}},subclass:function(t,e){if("function"!=typeof t)throw new Error("Parent must be a callable constructor");var a=(e=e||{}).hasOwnProperty("constructor")?e.constructor:function(){t.apply(this,arguments)};return a.prototype=Object.create(t.prototype),Object.keys(e).forEach(function(t){a.prototype[t]=e[t]}),a},ext:{}},E=7.301;function S(t,e,a){if(e&&a||!e&&!a)throw new Error(t+' must provide a parameter specifying either "build" or "source". It should not specify both.');if(e&&-1===["GRCh37","GRCh38"].indexOf(e))throw new Error(t+" must specify a valid genome build number")}L.Layouts=(D={plot:{},panel:{},data_layer:{},dashboard:{},dashboard_components:{},tooltip:{}},(w={}).get=function(t,e,a){if("string"!=typeof t||"string"!=typeof e)throw new Error("invalid arguments passed to LocusZoom.Layouts.get, requires string (layout type) and string (layout name)");if(D[t][e]){var i=L.Layouts.merge(a||{},D[t][e]);if(i.unnamespaced)return delete i.unnamespaced,JSON.parse(JSON.stringify(i));var p="";"string"==typeof i.namespace?p=i.namespace:"object"==typeof i.namespace&&Object.keys(i.namespace).length&&(p=void 0!==i.namespace.default?i.namespace.default:i.namespace[Object.keys(i.namespace)[0]].toString()),p+=p.length?":":"";var y=function(t,e){if(e?"string"==typeof e&&(e={default:e}):e={default:""},"string"==typeof t){for(var a,i,s,n,o=/\{\{namespace(\[[A-Za-z_0-9]+\]|)\}\}/g,r=[];null!==(a=o.exec(t));)i=a[0],s=a[1].length?a[1].replace(/(\[|\])/g,""):null,n=p,null!=e&&"object"==typeof e&&void 0!==e[s]&&(n=e[s]+(e[s].length?":":"")),r.push({base:i,namespace:n});for(var l in r)t=t.replace(r[l].base,r[l].namespace)}else if("object"==typeof t&&null!=t){if(void 0!==t.namespace){var h="string"==typeof t.namespace?{default:t.namespace}:t.namespace;e=L.Layouts.merge(e,h)}var u,d;for(var c in t)"namespace"!==c&&(u=y(t[c],e),c!==(d=y(c,e))&&delete t[c],t[d]=u)}return t};return i=y(i,i.namespace),JSON.parse(JSON.stringify(i))}throw new Error("layout type ["+t+"] name ["+e+"] not found")},w.set=function(t,e,a){if("string"!=typeof t||"string"!=typeof e||"object"!=typeof a)throw new Error("unable to set new layout; bad arguments passed to set()");return D[t]||(D[t]={}),a?D[t][e]=JSON.parse(JSON.stringify(a)):(delete D[t][e],null)},w.add=function(t,e,a){return w.set(t,e,a)},w.list=function(t){if(D[t])return Object.keys(D[t]);var e={};return Object.keys(D).forEach(function(t){e[t]=Object.keys(D[t])}),e},w.merge=function(t,e){if("object"!=typeof t||"object"!=typeof e)throw new Error("LocusZoom.Layouts.merge only accepts two layout objects; "+typeof t+", "+typeof e+" given");for(var a in e)if(e.hasOwnProperty(a)){var i=null===t[a]?"undefined":typeof t[a],s=typeof e[a];if("object"===i&&Array.isArray(t[a])&&(i="array"),"object"===s&&Array.isArray(e[a])&&(s="array"),"function"===i||"function"===s)throw new Error("LocusZoom.Layouts.merge encountered an unsupported property type");"undefined"!==i?"object"!==i||"object"!==s||(t[a]=L.Layouts.merge(t[a],e[a])):t[a]=JSON.parse(JSON.stringify(e[a]))}return t},w),L.Layouts.add("tooltip","standard_association",{namespace:{assoc:"assoc"},closable:!0,show:{or:["highlighted","selected"]},hide:{and:["unhighlighted","unselected"]},html:'<strong>{{{{namespace[assoc]}}variant|htmlescape}}</strong><br>P Value: <strong>{{{{namespace[assoc]}}log_pvalue|logtoscinotation|htmlescape}}</strong><br>Ref. Allele: <strong>{{{{namespace[assoc]}}ref_allele|htmlescape}}</strong><br><a href="javascript:void(0);" onclick="LocusZoom.getToolTipDataLayer(this).makeLDReference(LocusZoom.getToolTipData(this));">Make LD Reference</a><br>'}),L.Layouts.add("tooltip","standard_association_with_label",((x=L.Layouts.get("tooltip","standard_association",{unnamespaced:!0})).html+="<a href=\"javascript:void(0);\" onclick=\"var item = LocusZoom.getToolTipData(this), layer = LocusZoom.getToolTipDataLayer(this); var current = layer.getElementAnnotation(item, 'lz_show_label'); layer.setElementAnnotation(item, 'lz_show_label', !current ); layer.parent_plot.applyState();\">Toggle label</a>",x)),L.Layouts.add("tooltip","standard_genes",{closable:!0,show:{or:["highlighted","selected"]},hide:{and:["unhighlighted","unselected"]},html:'<h4><strong><i>{{gene_name|htmlescape}}</i></strong></h4>Gene ID: <a href="https://useast.ensembl.org/homo_sapiens/Gene/Summary?g={{gene_id|htmlescape}}&db=core" target="_blank" rel="noopener">{{gene_id|htmlescape}}</a><br>Transcript ID: <strong>{{transcript_id|htmlescape}}</strong><br>{{#if pLI}}<table><tr><th>Constraint</th><th>Expected variants</th><th>Observed variants</th><th>Const. Metric</th></tr><tr><td>Synonymous</td><td>{{exp_syn}}</td><td>{{obs_syn}}</td><td>z = {{syn_z}}<br>o/e = {{oe_syn}} ({{oe_syn_lower}} - {{oe_syn_upper}})</td></tr><tr><td>Missense</td><td>{{exp_mis}}</td><td>{{obs_mis}}</td><td>z = {{mis_z}}<br>o/e = {{oe_mis}} ({{oe_mis_lower}} - {{oe_mis_upper}})</td></tr><tr><td>pLoF</td><td>{{exp_lof}}</td><td>{{obs_lof}}</td><td>pLI = {{pLI}}<br>o/e = {{oe_lof}} ({{oe_lof_lower}} - {{oe_lof_upper}})</td></tr></table><br>{{/if}}<a href="https://gnomad.broadinstitute.org/gene/{{gene_id|htmlescape}}" target="_blank" rel="noopener">More data on gnomAD</a>'}),L.Layouts.add("tooltip","catalog_variant",{namespace:{assoc:"assoc",catalog:"catalog"},closable:!0,show:{or:["highlighted","selected"]},hide:{and:["unhighlighted","unselected"]},html:'<strong>{{{{namespace[catalog]}}variant|htmlescape}}</strong><br>Catalog entries: <strong>{{n_catalog_matches|htmlescape}}</strong><br>Top Trait: <strong>{{{{namespace[catalog]}}trait|htmlescape}}</strong><br>Top P Value: <strong>{{{{namespace[catalog]}}log_pvalue|logtoscinotation}}</strong><br>More: <a href="https://www.ebi.ac.uk/gwas/search?query={{{{namespace[catalog]}}rsid|htmlescape}}" target="_blank" rel="noopener">GWAS catalog</a> / <a href="https://www.ncbi.nlm.nih.gov/snp/{{{{namespace[catalog]}}rsid|htmlescape}}" target="_blank" rel="noopener">dbSNP</a>'}),L.Layouts.add("tooltip","coaccessibility",{namespace:{access:"access"},closable:!0,show:{or:["highlighted","selected"]},hide:{and:["unhighlighted","unselected"]},html:"<strong>Regulatory element</strong><br>{{{{namespace[access]}}start1|htmlescape}}-{{{{namespace[access]}}end1|htmlescape}}<br><strong>Promoter</strong><br>{{{{namespace[access]}}start2|htmlescape}}-{{{{namespace[access]}}end2|htmlescape}}<br>{{#if {{namespace[access]}}target}}<strong>Target</strong>: {{{{namespace[access]}}target|htmlescape}}<br>{{/if}}<strong>Score</strong>: {{{{namespace[access]}}score|htmlescape}}"}),L.Layouts.add("data_layer","significance",{id:"significance",type:"orthogonal_line",orientation:"horizontal",offset:E}),L.Layouts.add("data_layer","recomb_rate",{namespace:{recomb:"recomb"},id:"recombrate",type:"line",fields:["{{namespace[recomb]}}position","{{namespace[recomb]}}recomb_rate"],z_index:1,style:{stroke:"#0000FF","stroke-width":"1.5px"},x_axis:{field:"{{namespace[recomb]}}position"},y_axis:{axis:2,field:"{{namespace[recomb]}}recomb_rate",floor:0,ceiling:100}}),L.Layouts.add("data_layer","association_pvalues",{namespace:{assoc:"assoc",ld:"ld"},id:"associationpvalues",type:"scatter",point_shape:{scale_function:"if",field:"{{namespace[ld]}}isrefvar",parameters:{field_value:1,then:"diamond",else:"circle"}},point_size:{scale_function:"if",field:"{{namespace[ld]}}isrefvar",parameters:{field_value:1,then:80,else:40}},color:[{scale_function:"if",field:"{{namespace[ld]}}isrefvar",parameters:{field_value:1,then:"#9632b8"}},{scale_function:"numerical_bin",field:"{{namespace[ld]}}state",parameters:{breaks:[0,.2,.4,.6,.8],values:["#357ebd","#46b8da","#5cb85c","#eea236","#d43f3a"]}},"#B8B8B8"],legend:[{shape:"diamond",color:"#9632b8",size:40,label:"LD Ref Var",class:"lz-data_layer-scatter"},{shape:"circle",color:"#d43f3a",size:40,label:"1.0 > r² ≥ 0.8",class:"lz-data_layer-scatter"},{shape:"circle",color:"#eea236",size:40,label:"0.8 > r² ≥ 0.6",class:"lz-data_layer-scatter"},{shape:"circle",color:"#5cb85c",size:40,label:"0.6 > r² ≥ 0.4",class:"lz-data_layer-scatter"},{shape:"circle",color:"#46b8da",size:40,label:"0.4 > r² ≥ 0.2",class:"lz-data_layer-scatter"},{shape:"circle",color:"#357ebd",size:40,label:"0.2 > r² ≥ 0.0",class:"lz-data_layer-scatter"},{shape:"circle",color:"#B8B8B8",size:40,label:"no r² data",class:"lz-data_layer-scatter"}],label:null,fields:["{{namespace[assoc]}}variant","{{namespace[assoc]}}position","{{namespace[assoc]}}log_pvalue","{{namespace[assoc]}}log_pvalue|logtoscinotation","{{namespace[assoc]}}ref_allele","{{namespace[ld]}}state","{{namespace[ld]}}isrefvar"],id_field:"{{namespace[assoc]}}variant",z_index:2,x_axis:{field:"{{namespace[assoc]}}position"},y_axis:{axis:1,field:"{{namespace[assoc]}}log_pvalue",floor:0,upper_buffer:.1,min_extent:[0,10]},behaviors:{onmouseover:[{action:"set",status:"highlighted"}],onmouseout:[{action:"unset",status:"highlighted"}],onclick:[{action:"toggle",status:"selected",exclusive:!0}],onshiftclick:[{action:"toggle",status:"selected"}]},tooltip:L.Layouts.get("tooltip","standard_association",{unnamespaced:!0})}),L.Layouts.add("data_layer","coaccessibility",{namespace:{access:"access"},id:"coaccessibility",type:"arcs",fields:["{{namespace[access]}}start1","{{namespace[access]}}end1","{{namespace[access]}}start2","{{namespace[access]}}end2","{{namespace[access]}}id","{{namespace[access]}}target","{{namespace[access]}}score"],match:{send:"{{namespace[access]}}target",receive:"{{namespace[access]}}target"},id_field:"{{namespace[access]}}id",filters:[["{{namespace[access]}}score","!=",null]],color:[{field:"lz_highlight_match",scale_function:"if",parameters:{field_value:!0,then:"#ff0000"}},{field:"lz_highlight_match",scale_function:"if",parameters:{field_value:!1,then:"#EAE6E6"}},{scale_function:"ordinal_cycle",parameters:{values:g.scale.category20().range()}}],x_axis:{field1:"{{namespace[access]}}start1",field2:"{{namespace[access]}}start2"},y_axis:{axis:1,field:"{{namespace[access]}}score",upper_buffer:.1,min_extent:[0,1]},behaviors:{onmouseover:[{action:"set",status:"highlighted"}],onmouseout:[{action:"unset",status:"highlighted"}],onclick:[{action:"toggle",status:"selected",exclusive:!0}],onshiftclick:[{action:"toggle",status:"selected"}]},tooltip:L.Layouts.get("tooltip","coaccessibility",{unnamespaced:!0})}),L.Layouts.add("data_layer","association_pvalues_catalog",((v=L.Layouts.get("data_layer","association_pvalues",{unnamespaced:!0,id:"associationpvaluescatalog",fill_opacity:.7})).tooltip.html+='{{#if {{namespace[catalog]}}rsid}}<br><a href="https://www.ebi.ac.uk/gwas/search?query={{{{namespace[catalog]}}rsid|htmlescape}}" target="_blank" rel="noopener">See hits in GWAS catalog</a>{{/if}}',v.namespace.catalog="catalog",v.fields.push("{{namespace[catalog]}}rsid","{{namespace[catalog]}}trait","{{namespace[catalog]}}log_pvalue"),v)),L.Layouts.add("data_layer","phewas_pvalues",{namespace:{phewas:"phewas"},id:"phewaspvalues",type:"category_scatter",point_shape:"circle",point_size:70,tooltip_positioning:"vertical",id_field:"{{namespace[phewas]}}id",fields:["{{namespace[phewas]}}id","{{namespace[phewas]}}log_pvalue","{{namespace[phewas]}}trait_group","{{namespace[phewas]}}trait_label"],x_axis:{field:"{{namespace[phewas]}}x",category_field:"{{namespace[phewas]}}trait_group",lower_buffer:.025,upper_buffer:.025},y_axis:{axis:1,field:"{{namespace[phewas]}}log_pvalue",floor:0,upper_buffer:.15},color:[{field:"{{namespace[phewas]}}trait_group",scale_function:"categorical_bin",parameters:{categories:[],values:[],null_value:"#B8B8B8"}}],fill_opacity:.7,tooltip:{closable:!0,show:{or:["highlighted","selected"]},hide:{and:["unhighlighted","unselected"]},html:["<strong>Trait:</strong> {{{{namespace[phewas]}}trait_label|htmlescape}}<br>","<strong>Trait Category:</strong> {{{{namespace[phewas]}}trait_group|htmlescape}}<br>","<strong>P-value:</strong> {{{{namespace[phewas]}}log_pvalue|logtoscinotation|htmlescape}}<br>"].join("")},behaviors:{onmouseover:[{action:"set",status:"highlighted"}],onmouseout:[{action:"unset",status:"highlighted"}],onclick:[{action:"toggle",status:"selected",exclusive:!0}],onshiftclick:[{action:"toggle",status:"selected"}]},label:{text:"{{{{namespace[phewas]}}trait_label|htmlescape}}",spacing:6,lines:{style:{"stroke-width":"2px",stroke:"#333333","stroke-dasharray":"2px 2px"}},filters:[{field:"{{namespace[phewas]}}log_pvalue",operator:">=",value:20}],style:{"font-size":"14px","font-weight":"bold",fill:"#333333"}}}),L.Layouts.add("data_layer","genes",{namespace:{gene:"gene",constraint:"constraint"},id:"genes",type:"genes",fields:["{{namespace[gene]}}all","{{namespace[constraint]}}all"],id_field:"gene_id",behaviors:{onmouseover:[{action:"set",status:"highlighted"}],onmouseout:[{action:"unset",status:"highlighted"}],onclick:[{action:"toggle",status:"selected",exclusive:!0}],onshiftclick:[{action:"toggle",status:"selected"}]},tooltip:L.Layouts.get("tooltip","standard_genes",{unnamespaced:!0})}),L.Layouts.add("data_layer","annotation_catalog",{namespace:{assoc:"assoc",catalog:"catalog"},id:"annotation_catalog",type:"annotation_track",id_field:"{{namespace[catalog]}}variant",x_axis:{field:"{{namespace[assoc]}}position"},color:"#0000CC",fields:["{{namespace[assoc]}}variant","{{namespace[assoc]}}chromosome","{{namespace[assoc]}}position","{{namespace[catalog]}}variant","{{namespace[catalog]}}rsid","{{namespace[catalog]}}trait","{{namespace[catalog]}}log_pvalue","{{namespace[catalog]}}pos"],filters:[["{{namespace[catalog]}}rsid","!=",null],["{{namespace[catalog]}}log_pvalue",">",E]],behaviors:{onmouseover:[{action:"set",status:"highlighted"}],onmouseout:[{action:"unset",status:"highlighted"}],onclick:[{action:"toggle",status:"selected",exclusive:!0}],onshiftclick:[{action:"toggle",status:"selected"}]},tooltip:L.Layouts.get("tooltip","catalog_variant",{unnamespaced:!0}),tooltip_positioning:"top"}),L.Layouts.add("dashboard_components","ldlz2_pop_selector",{type:"set_state",position:"right",color:"blue",button_html:"LD Population: ",show_selected:!0,button_title:"Select LD Population: ",state_field:"ld_pop",options:[{display_name:"ALL (default)",value:"ALL"},{display_name:"AFR",value:"AFR"},{display_name:"AMR",value:"AMR"},{display_name:"EAS",value:"EAS"},{display_name:"EUR",value:"EUR"},{display_name:"SAS",value:"SAS"}]}),L.Layouts.add("dashboard","standard_panel",{components:[{type:"remove_panel",position:"right",color:"red",group_position:"end"},{type:"move_panel_up",position:"right",group_position:"middle"},{type:"move_panel_down",position:"right",group_position:"start",style:{"margin-left":"0.75em"}}]}),L.Layouts.add("dashboard","standard_plot",{components:[{type:"title",title:"LocusZoom",subtitle:'<a href="https://statgen.github.io/locuszoom/" target="_blank" rel="noopener">v'+L.version+"</a>",position:"left"},{type:"download",position:"right"}]}),L.Layouts.add("dashboard","region_nav_plot",((b=L.Layouts.get("dashboard","standard_plot",{unnamespaced:!0})).components.push({type:"shift_region",step:5e5,button_html:">>",position:"right",group_position:"end"},{type:"shift_region",step:5e4,button_html:">",position:"right",group_position:"middle"},{type:"zoom_region",step:.2,position:"right",group_position:"middle"},{type:"zoom_region",step:-.2,position:"right",group_position:"middle"},{type:"shift_region",step:-5e4,button_html:"<",position:"right",group_position:"middle"},{type:"shift_region",step:-5e5,button_html:"<<",position:"right",group_position:"start"}),b)),L.Layouts.add("panel","association",{id:"association",width:800,height:225,min_width:400,min_height:200,proportional_width:1,margin:{top:35,right:50,bottom:40,left:50},inner_border:"rgb(210, 210, 210)",dashboard:(m=L.Layouts.get("dashboard","standard_panel",{unnamespaced:!0}),m.components.push({type:"toggle_legend",position:"right"}),m),axes:{x:{label:"Chromosome {{chr}} (Mb)",label_offset:32,tick_format:"region",extent:"state"},y1:{label:"-log10 p-value",label_offset:28},y2:{label:"Recombination Rate (cM/Mb)",label_offset:40}},legend:{orientation:"vertical",origin:{x:55,y:40},hidden:!0},interaction:{drag_background_to_pan:!0,drag_x_ticks_to_scale:!0,drag_y1_ticks_to_scale:!0,drag_y2_ticks_to_scale:!0,scroll_to_zoom:!0,x_linked:!0},data_layers:[L.Layouts.get("data_layer","significance",{unnamespaced:!0}),L.Layouts.get("data_layer","recomb_rate",{unnamespaced:!0}),L.Layouts.get("data_layer","association_pvalues",{unnamespaced:!0})]}),L.Layouts.add("panel","coaccessibility",{id:"coaccessibility",width:800,height:225,min_width:400,min_height:100,proportional_width:1,margin:{top:35,right:50,bottom:40,left:50},inner_border:"rgb(210, 210, 210)",dashboard:L.Layouts.get("dashboard","standard_panel",{unnamespaced:!0}),axes:{x:{label:"Chromosome {{chr}} (Mb)",label_offset:32,tick_format:"region",extent:"state"},y1:{label:"Score",label_offset:28,render:!1}},interaction:{drag_background_to_pan:!0,drag_x_ticks_to_scale:!0,drag_y1_ticks_to_scale:!0,scroll_to_zoom:!0,x_linked:!0},data_layers:[L.Layouts.get("data_layer","coaccessibility",{unnamespaced:!0})]}),L.Layouts.add("panel","association_catalog",((f=L.Layouts.get("panel","association",{unnamespaced:!0,id:"associationcatalog",namespace:{assoc:"assoc",ld:"ld",catalog:"catalog"}})).dashboard.components.push({type:"display_options",position:"right",color:"blue",button_html:"Display options...",button_title:"Control how plot items are displayed",layer_name:"associationpvaluescatalog",default_config_display_name:"No catalog labels (default)",options:[{display_name:"Label catalog traits",display:{label:{text:"{{{{namespace[catalog]}}trait|htmlescape}}",spacing:6,lines:{style:{"stroke-width":"2px",stroke:"#333333","stroke-dasharray":"2px 2px"}},filters:[{field:"{{namespace[catalog]}}trait",operator:"!=",value:null},{field:"{{namespace[catalog]}}log_pvalue",operator:">",value:E},{field:"{{namespace[ld]}}state",operator:">",value:.4}],style:{"font-size":"10px","font-weight":"bold",fill:"#333333"}}}}]}),f.data_layers=[L.Layouts.get("data_layer","significance",{unnamespaced:!0}),L.Layouts.get("data_layer","recomb_rate",{unnamespaced:!0}),L.Layouts.get("data_layer","association_pvalues_catalog",{unnamespaced:!0})],f)),L.Layouts.add("panel","genes",{id:"genes",width:800,height:225,min_width:400,min_height:112.5,proportional_width:1,margin:{top:20,right:50,bottom:20,left:50},axes:{},interaction:{drag_background_to_pan:!0,scroll_to_zoom:!0,x_linked:!0},dashboard:(_=L.Layouts.get("dashboard","standard_panel",{unnamespaced:!0}),_.components.push({type:"resize_to_data",position:"right",button_html:"Show all genes"}),_),data_layers:[L.Layouts.get("data_layer","genes",{unnamespaced:!0})]}),L.Layouts.add("panel","phewas",{id:"phewas",width:800,height:300,min_width:800,min_height:300,proportional_width:1,margin:{top:20,right:50,bottom:120,left:50},inner_border:"rgb(210, 210, 210)",axes:{x:{ticks:{style:{"font-weight":"bold","font-size":"11px","text-anchor":"start"},transform:"rotate(50)",position:"left"}},y1:{label:"-log10 p-value",label_offset:28}},data_layers:[L.Layouts.get("data_layer","significance",{unnamespaced:!0}),L.Layouts.get("data_layer","phewas_pvalues",{unnamespaced:!0})]}),L.Layouts.add("panel","annotation_catalog",{id:"annotationcatalog",width:800,height:50,min_height:50,proportional_width:1,margin:{top:25,right:50,bottom:0,left:50},inner_border:"rgb(210, 210, 210)",dashboard:L.Layouts.get("dashboard","standard_panel",{unnamespaced:!0}),interaction:{drag_background_to_pan:!0,scroll_to_zoom:!0,x_linked:!0},data_layers:[L.Layouts.get("data_layer","annotation_catalog",{unnamespaced:!0})]}),L.Layouts.add("plot","standard_association",{state:{},width:800,height:450,responsive_resize:"both",min_region_scale:2e4,max_region_scale:1e6,dashboard:L.Layouts.get("dashboard","standard_plot",{unnamespaced:!0}),panels:[L.Layouts.get("panel","association",{unnamespaced:!0,proportional_height:.5}),L.Layouts.get("panel","genes",{unnamespaced:!0,proportional_height:.5})]}),L.Layouts.add("plot","association_catalog",{state:{},width:800,height:500,responsive_resize:"width_only",min_region_scale:2e4,max_region_scale:1e6,dashboard:L.Layouts.get("dashboard","standard_plot",{unnamespaced:!0}),panels:[L.Layouts.get("panel","annotation_catalog",{unnamespaced:!0}),L.Layouts.get("panel","association_catalog",{unnamespaced:!0}),L.Layouts.get("panel","genes",{unnamespaced:!0})]}),L.StandardLayout=L.Layouts.get("plot","standard_association"),L.Layouts.add("plot","standard_phewas",{width:800,height:600,min_width:800,min_height:600,responsive_resize:"both",dashboard:L.Layouts.get("dashboard","standard_plot",{unnamespaced:!0}),panels:[L.Layouts.get("panel","phewas",{unnamespaced:!0,proportional_height:.5}),L.Layouts.get("panel","genes",{unnamespaced:!0,proportional_height:.5,margin:{bottom:40},axes:{x:{label:"Chromosome {{chr}} (Mb)",label_offset:32,tick_format:"region",extent:"state"}}})],mouse_guide:!1}),L.Layouts.add("plot","coaccessibility",{state:{},width:800,height:450,responsive_resize:"both",min_region_scale:2e4,max_region_scale:1e6,dashboard:L.Layouts.get("dashboard","region_nav_plot",{unnamespaced:!0}),panels:[L.Layouts.get("panel","coaccessibility",{unnamespaced:!0,proportional_height:.4}),(t=L.Layouts.get("panel","genes",{unnamespaced:!0,proportional_height:.6}),p=t.data_layers[0],y=[{field:"lz_highlight_match",scale_function:"if",parameters:{field_value:!0,then:"#ff0000"}},{field:"lz_highlight_match",scale_function:"if",parameters:{field_value:!(p.match={send:"gene_name",receive:"gene_name"}),then:"#EAE6E6"}},"#363696"],p.color=y,p.stroke=y,t)]}),L.DataLayer=function(t,e){return this.initialized=!1,this.layout_idx=null,this.id=null,this.parent=e||null,this.svg={},this.parent_plot=null,void 0!==e&&e instanceof L.Panel&&(this.parent_plot=e.parent),this.layout=L.Layouts.merge(t||{},L.DataLayer.DefaultLayout),this.layout.id&&(this.id=this.layout.id),this.layout.x_axis!=={}&&"number"!=typeof this.layout.x_axis.axis&&(this.layout.x_axis.axis=1),this.layout.y_axis!=={}&&"number"!=typeof this.layout.y_axis.axis&&(this.layout.y_axis.axis=1),this._base_layout=JSON.parse(JSON.stringify(this.layout)),this.state={},this.state_id=null,this.layer_state=null,this._setDefaultState(),this.data=[],this.layout.tooltip&&(this.tooltips={}),this.global_statuses={highlighted:!1,selected:!1,faded:!1,hidden:!1},this},L.DataLayer.prototype.addField=function(t,e,a){if(!t||!e)throw new Error("Must specify field name and namespace to use when adding field");var i=e+":"+t;if(a)if(i+="|","string"==typeof a)i+=a;else{if(!Array.isArray(a))throw new Error("Must provide transformations as either a string or array of strings");i+=a.join("|")}var s=this.layout.fields;return-1===s.indexOf(i)&&s.push(i),i},L.DataLayer.prototype._setDefaultState=function(){var t={status_flags:{},extra_fields:{}},e=t.status_flags;L.DataLayer.Statuses.adjectives.forEach(function(t){e[t]=e[t]||[]}),e.has_tooltip=e.has_tooltip||[],this.parent&&(this.state_id=this.parent.id+"."+this.id,this.state=this.parent.state,this.state[this.state_id]=t),this.layer_state=t},L.DataLayer.DefaultLayout={type:"",fields:[],x_axis:{},y_axis:{},tooltip_positioning:"horizontal"},L.DataLayer.Statuses={verbs:["highlight","select","fade","hide"],adjectives:["highlighted","selected","faded","hidden"],menu_antiverbs:["unhighlight","deselect","unfade","show"]},L.DataLayer.prototype.getBaseId=function(){return this.parent?this.parent_plot.id+"."+this.parent.id+"."+this.id:""},L.DataLayer.prototype.getAbsoluteDataHeight=function(){return this.svg.group.node().getBoundingClientRect().height},L.DataLayer.prototype.getElementId=function(t){var e="element";if("string"==typeof t)e=t;else if("object"==typeof t){var a=this.layout.id_field||"id";if(void 0===t[a])throw new Error("Unable to generate element ID");e=t[a].toString().replace(/\W/g,"")}return(this.getBaseId()+"-"+e).replace(/([:.[\],])/g,"_")},L.DataLayer.prototype.getElementStatusNodeId=function(t){return null},L.DataLayer.prototype.getElementById=function(t){var e=g.select("#"+t.replace(/([:.[\],])/g,"\\$1"));return!e.empty()&&e.data()&&e.data().length?e.data()[0]:null},L.DataLayer.prototype.applyDataMethods=function(){var e=this.layout.match&&this.layout.match.receive,i=this.parent_plot.state.lz_match_value,s=this;return this.data.forEach(function(t,a){e&&null!=i&&(t.lz_highlight_match=t[e]===i),s.data[a].toHTML=function(){var t=s.layout.id_field||"id",e="";return s.data[a][t]&&(e=s.data[a][t].toString()),e},s.data[a].getDataLayer=function(){return s},s.data[a].deselect=function(){s.getDataLayer().unselectElement(s)}}),this.applyCustomDataMethods(),this},L.DataLayer.prototype.applyCustomDataMethods=function(){return this},L.DataLayer.prototype.initialize=function(){return this.svg.container=this.parent.svg.group.append("g").attr("class","lz-data_layer-container").attr("id",this.getBaseId()+".data_layer_container"),this.svg.clipRect=this.svg.container.append("clipPath").attr("id",this.getBaseId()+".clip").append("rect"),this.svg.group=this.svg.container.append("g").attr("id",this.getBaseId()+".data_layer").attr("clip-path","url(#"+this.getBaseId()+".clip)"),this},L.DataLayer.prototype.moveUp=function(){return this.parent.data_layer_ids_by_z_index[this.layout.z_index+1]&&(this.parent.data_layer_ids_by_z_index[this.layout.z_index]=this.parent.data_layer_ids_by_z_index[this.layout.z_index+1],this.parent.data_layer_ids_by_z_index[this.layout.z_index+1]=this.id,this.parent.resortDataLayers()),this},L.DataLayer.prototype.moveDown=function(){return this.parent.data_layer_ids_by_z_index[this.layout.z_index-1]&&(this.parent.data_layer_ids_by_z_index[this.layout.z_index]=this.parent.data_layer_ids_by_z_index[this.layout.z_index-1],this.parent.data_layer_ids_by_z_index[this.layout.z_index-1]=this.id,this.parent.resortDataLayers()),this},L.DataLayer.prototype.resolveScalableParameter=function(t,e,a){var i=null;if(Array.isArray(t))for(var s=0;null===i&&s<t.length;)i=this.resolveScalableParameter(t[s],e,a),s++;else switch(typeof t){case"number":case"string":i=t;break;case"object":if(t.scale_function)if(t.field){var n,o=new L.Data.Field(t.field);try{n=this.layer_state&&this.layer_state.extra_fields[this.getElementId(e)]}catch(t){n=null}i=L.ScaleFunctions.get(t.scale_function,t.parameters||{},o.resolve(e,n),a)}else i=L.ScaleFunctions.get(t.scale_function,t.parameters||{},e,a)}return i},L.DataLayer.prototype._getDataExtent=function(t,e){return t=t||this.data,g.extent(t,function(t){return+new L.Data.Field(e.field).resolve(t)})},L.DataLayer.prototype.getAxisExtent=function(t){if(-1===["x","y"].indexOf(t))throw new Error("Invalid dimension identifier passed to LocusZoom.DataLayer.getAxisExtent()");var e=t+"_axis",a=this.layout[e];if(!isNaN(a.floor)&&!isNaN(a.ceiling))return[+a.floor,+a.ceiling];var i=[];if(a.field&&this.data){if(this.data.length){var s=(i=this._getDataExtent(this.data,a))[1]-i[0];if(isNaN(a.lower_buffer)||(i[0]-=s*a.lower_buffer),isNaN(a.upper_buffer)||(i[1]+=s*a.upper_buffer),"object"==typeof a.min_extent){var n=a.min_extent[0],o=a.min_extent[1];isNaN(n)||isNaN(o)||(i[0]=Math.min(i[0],n)),isNaN(o)||(i[1]=Math.max(i[1],o))}return[isNaN(a.floor)?i[0]:a.floor,isNaN(a.ceiling)?i[1]:a.ceiling]}return i=a.min_extent||[]}return"x"!==t||isNaN(this.state.start)||isNaN(this.state.end)?[]:[this.state.start,this.state.end]},L.DataLayer.prototype.getTicks=function(t,e){if(-1===["x","y1","y2"].indexOf(t))throw new Error("Invalid dimension identifier at layer level"+t);return[]},L.DataLayer.prototype.createTooltip=function(t){if("object"!=typeof this.layout.tooltip)throw new Error("DataLayer ["+this.id+"] layout does not define a tooltip");var e=this.getElementId(t);if(!this.tooltips[e])return this.tooltips[e]={data:t,arrow:null,selector:g.select(this.parent_plot.svg.node().parentNode).append("div").attr("class","lz-data_layer-tooltip").attr("id",e+"-tooltip")},this.layer_state.status_flags.has_tooltip.push(e),this.updateTooltip(t),this;this.positionTooltip(e)},L.DataLayer.prototype.updateTooltip=function(t,e){return void 0===e&&(e=this.getElementId(t)),this.tooltips[e].selector.html(""),this.tooltips[e].arrow=null,this.layout.tooltip.html&&this.tooltips[e].selector.html(L.parseFields(t,this.layout.tooltip.html)),this.layout.tooltip.closable&&this.tooltips[e].selector.insert("button",":first-child").attr("class","lz-tooltip-close-button").attr("title","Close").text("×").on("click",function(){this.destroyTooltip(e)}.bind(this)),this.tooltips[e].selector.data([t]),this.positionTooltip(e),this},L.DataLayer.prototype.destroyTooltip=function(t,e){var a;if(a="string"==typeof t?t:this.getElementId(t),this.tooltips[a]&&("object"==typeof this.tooltips[a].selector&&this.tooltips[a].selector.remove(),delete this.tooltips[a]),!e){var i=this.layer_state.status_flags.has_tooltip,s=i.indexOf(a);i.splice(s,1)}return this},L.DataLayer.prototype.destroyAllTooltips=function(){for(var t in this.tooltips)this.destroyTooltip(t,!0);return this},L.DataLayer.prototype.positionTooltip=function(t){if("string"!=typeof t)throw new Error("Unable to position tooltip: id is not a string");if(!this.tooltips[t])throw new Error("Unable to position tooltip: id does not point to a valid tooltip");var e=this.tooltips[t],a=this._getTooltipPosition(e);if(!a)return null;this._drawTooltip(e,this.layout.tooltip_positioning,a.x_min,a.x_max,a.y_min,a.y_max)},L.DataLayer.prototype._getTooltipPosition=function(t){var e=this.parent,a=e["y"+this.layout.y_axis.axis+"_scale"],i=e["y"+this.layout.y_axis.axis+"_extent"],s=e.x_scale(e.x_extent[0]),n=a(i[0]);return{x_min:s,x_max:s,y_min:n,y_max:n}},L.DataLayer.prototype._drawTooltip=function(t,e,a,i,s,n){var o,r,l,h,u,d=this.parent.layout,c=this.layout,p=this.getPageOrigin(),y=t.selector.node().getBoundingClientRect(),_=d.height-(d.margin.top+d.margin.bottom),f=d.width-(d.margin.left+d.margin.right),g=((a=Math.max(a,0))+(i=Math.min(i,f)))/2,m=((s=Math.max(s,0))+(n=Math.min(n,_)))/2,b=i-g,v=n-m,x=c.tooltip_positioning;if("vertical"===x?(b=0,x=y.height+8>_-(m+v)?"top":"bottom"):"horizontal"===x&&(v=0,x=g<=d.width/2?"left":"right"),"top"===x||"bottom"===x){var w=Math.max(y.width/2-g,0),D=Math.max(y.width/2+g-f,0);r=p.x+g-y.width/2-D+w,u=p.x+g-r-7,"top"===x?(o=p.y+m-(v+y.height+8),l="down",h=y.height-1):(o=p.y+m+v+8,l="up",h=-8)}else{if("left"!==x&&"right"!==x)throw new Error("Unrecognized placement value");"left"===x?(r=p.x+g+b+8,l="left",u=-8):(r=p.x+g-y.width-b-8,l="right",u=y.width-1),m-y.height/2<=0?(o=p.y+m-10.5-6,h=6):m+y.height/2>=_?(o=p.y+m+7+6-y.height,h=y.height-14-6):(o=p.y+m-y.height/2,h=y.height/2-7)}return t.selector.style("left",r+"px").style("top",o+"px"),t.arrow||(t.arrow=t.selector.append("div").style("position","absolute")),t.arrow.attr("class","lz-data_layer-tooltip-arrow_"+l).style("left",u+"px").style("top",h+"px"),this},L.DataLayer.prototype.positionAllTooltips=function(){for(var t in this.tooltips)this.positionTooltip(t);return this},L.DataLayer.prototype.showOrHideTooltip=function(t,e){if("object"==typeof this.layout.tooltip){var a=this.getElementId(t),o=function(a,t,i){var e=null;if("object"!=typeof a||null===a)return null;if(Array.isArray(t))i=i||"and",e=1===t.length?a[t[0]]:t.reduce(function(t,e){return"and"===i?a[t]&&a[e]:"or"===i?a[t]||a[e]:null});else{if("object"!=typeof t)return!1;var s;for(var n in t)s=o(a,t[n],n),null===e?e=s:"and"===i?e=e&&s:"or"===i&&(e=e||s)}return e},i={};"string"==typeof this.layout.tooltip.show?i={and:[this.layout.tooltip.show]}:"object"==typeof this.layout.tooltip.show&&(i=this.layout.tooltip.show);var s={};"string"==typeof this.layout.tooltip.hide?s={and:[this.layout.tooltip.hide]}:"object"==typeof this.layout.tooltip.hide&&(s=this.layout.tooltip.hide);var n=this.layer_state,r={};L.DataLayer.Statuses.adjectives.forEach(function(t){var e="un"+t;r[t]=-1!==n.status_flags[t].indexOf(a),r[e]=!r[t]});var l=o(r,i),h=o(r,s),u=-1!==n.status_flags.has_tooltip.indexOf(a);return!l||!e&&!u||h?this.destroyTooltip(t):this.createTooltip(t),this}},L.DataLayer.prototype.filter=function(e,a){if(void 0!==a&&-1!==["indexes","elements"].indexOf(a)||(a="indexes"),!Array.isArray(e))return[];var i=[];return this.data.forEach(function(s,t){var n=!0;e.forEach(function(t){var e,a,i;e=s,a=t,i={"=":function(t,e){return t===e},"!=":function(t,e){return t!=e},"<":function(t,e){return t<e},"<=":function(t,e){return t<=e},">":function(t,e){return e<t},">=":function(t,e){return e<=t},"%":function(t,e){return t%e}},Array.isArray(a)&&(2===a.length?e[a[0]]===a[1]:3===a.length&&i[a[1]]&&i[a[1]](e[a[0]],a[2]))||(n=!1)}),n&&i.push("indexes"===a?t:s)}),i},L.DataLayer.prototype.filterIndexes=function(t){return this.filter(t,"indexes")},L.DataLayer.prototype.filterElements=function(t){return this.filter(t,"elements")},L.DataLayer.Statuses.verbs.forEach(function(t,e){var a=L.DataLayer.Statuses.adjectives[e],i="un"+t;L.DataLayer.prototype[t+"Element"]=function(t,e){return e=void 0!==e&&!!e,this.setElementStatus(a,t,!0,e),this},L.DataLayer.prototype[i+"Element"]=function(t,e){return e=void 0!==e&&!!e,this.setElementStatus(a,t,!1,e),this},L.DataLayer.prototype[t+"ElementsByFilters"]=function(t,e){return e=void 0!==e&&!!e,this.setElementStatusByFilters(a,!0,t,e)},L.DataLayer.prototype[i+"ElementsByFilters"]=function(t,e){return e=void 0!==e&&!!e,this.setElementStatusByFilters(a,!1,t,e)},L.DataLayer.prototype[t+"AllElements"]=function(){return this.setAllElementStatus(a,!0),this},L.DataLayer.prototype[i+"AllElements"]=function(){return this.setAllElementStatus(a,!1),this}}),L.DataLayer.prototype.setElementStatus=function(t,e,a,i){if("has_tooltip"===t)return this;void 0===a&&(a=!0);try{var s=this.getElementId(e)}catch(t){return this}i&&this.setAllElementStatus(t,!a),g.select("#"+s).classed("lz-data_layer-"+this.layout.type+"-"+t,a);var n=this.getElementStatusNodeId(e);null!==n&&g.select("#"+n).classed("lz-data_layer-"+this.layout.type+"-statusnode-"+t,a);var o=this.layer_state.status_flags[t].indexOf(s),r=-1===o;a&&r&&this.layer_state.status_flags[t].push(s),a||r||this.layer_state.status_flags[t].splice(o,1),this.showOrHideTooltip(e,r),r&&this.parent.emit("layout_changed",!0);var l="selected"===t;!l||!r&&a||this.parent.emit("element_selection",{element:e,active:a},!0);var h=this.layout.match&&this.layout.match.send;return l&&h&&(r||!a)&&this.parent.emit("match_requested",{value:e[h],active:a},!0),this},L.DataLayer.prototype.setElementStatusByFilters=function(e,a,t,i){if(void 0===e||-1===L.DataLayer.Statuses.adjectives.indexOf(e))throw new Error("Invalid status passed to DataLayer.setElementStatusByFilters()");return void 0===this.layer_state.status_flags[e]||(a=void 0===a||!!a,i=void 0!==i&&!!i,Array.isArray(t)||(t=[]),i&&this.setAllElementStatus(e,!a),this.filterElements(t).forEach(function(t){this.setElementStatus(e,t,a)}.bind(this))),this},L.DataLayer.prototype.setAllElementStatus=function(a,t){if(void 0===a||-1===L.DataLayer.Statuses.adjectives.indexOf(a))throw new Error("Invalid status passed to DataLayer.setAllElementStatus()");if(void 0===this.layer_state.status_flags[a])return this;void 0===t&&(t=!0);var i=this;t?this.data.forEach(function(t){i.setElementStatus(a,t,!0)}):(this.layer_state.status_flags[a].slice().forEach(function(t){var e=i.getElementById(t);"object"==typeof e&&null!==e&&i.setElementStatus(a,e,!1)}),this.layer_state.status_flags[a]=[]);return this.global_statuses[a]=t,this},L.DataLayer.prototype.setElementAnnotation=function(t,e,a){var i=this.getElementId(t);return this.layer_state.extra_fields[i]||(this.layer_state.extra_fields[i]={}),this.layer_state.extra_fields[i][e]=a,this},L.DataLayer.prototype.getElementAnnotation=function(t,e){var a=this.getElementId(t),i=this.layer_state.extra_fields[a];return i&&i[e]},L.DataLayer.prototype.applyBehaviors=function(a){"object"==typeof this.layout.behaviors&&Object.keys(this.layout.behaviors).forEach(function(t){var e=/(click|mouseover|mouseout)/.exec(t);e&&a.on(e[0]+"."+t,this.executeBehaviors(t,this.layout.behaviors[t]))}.bind(this))},L.DataLayer.prototype.executeBehaviors=function(t,e){var a=-1!==t.indexOf("ctrl"),i=-1!==t.indexOf("shift"),n=this;return function(s){a===!!g.event.ctrlKey&&i===!!g.event.shiftKey&&e.forEach(function(t){if("object"==typeof t&&null!==t)switch(t.action){case"set":n.setElementStatus(t.status,s,!0,t.exclusive);break;case"unset":n.setElementStatus(t.status,s,!1,t.exclusive);break;case"toggle":var e=-1!==n.layer_state.status_flags[t.status].indexOf(n.getElementId(s)),a=t.exclusive&&!e;n.setElementStatus(t.status,s,!e,a);break;case"link":if("string"==typeof t.href){var i=L.parseFields(s,t.href);"string"==typeof t.target?window.open(i,t.target):window.location.href=i}}})}},L.DataLayer.prototype.getPageOrigin=function(){var t=this.parent.getPageOrigin();return{x:t.x+this.parent.layout.margin.left,y:t.y+this.parent.layout.margin.top}},L.DataLayer.prototype.exportData=function(t){var e,a="json";switch(t="string"==typeof(t=t||a)?t.toLowerCase():a,-1===["json","csv","tsv"].indexOf(t)&&(t=a),t){case"json":try{e=JSON.stringify(this.data)}catch(t){e=null,console.warn("Unable to export JSON data from data layer: "+this.getBaseId()),console.error(t)}break;case"tsv":case"csv":try{var i=JSON.parse(JSON.stringify(this.data));if("object"!=typeof i)e=i.toString();else if(Array.isArray(i)){var s="tsv"===t?"\t":",";e=this.layout.fields.map(function(t){return JSON.stringify(t)}).join(s)+"\n"+i.map(function(e){return this.layout.fields.map(function(t){return void 0===e[t]?JSON.stringify(null):"object"==typeof e[t]&&null!==e[t]?Array.isArray(e[t])?'"[Array('+e[t].length+')]"':'"[Object]"':JSON.stringify(e[t])}).join(s)}.bind(this)).join("\n")}else e="Object"}catch(t){e=null,console.error("Unable to export CSV data from data layer: "+this.getBaseId()+";",t)}}return e},L.DataLayer.prototype.applyAllElementStatus=function(){var t=this.layer_state.status_flags,e=this;for(var a in t)t.hasOwnProperty(a)&&Array.isArray(t[a])&&t[a].forEach(function(t){try{e.setElementStatus(a,e.getElementById(t),!0)}catch(t){console.warn("Unable to apply state: "+e.state_id+", "+a),console.error(t)}})},L.DataLayer.prototype.draw=function(){return this.svg.container.attr("transform","translate("+this.parent.layout.cliparea.origin.x+","+this.parent.layout.cliparea.origin.y+")"),this.svg.clipRect.attr("width",this.parent.layout.cliparea.width).attr("height",this.parent.layout.cliparea.height),this.positionAllTooltips(),this},L.DataLayer.prototype.reMap=function(){this.destroyAllTooltips();var t=this.parent_plot.lzd.getData(this.state,this.layout.fields);return t.then(function(t){this.data=t.body,this.applyDataMethods(),this.initialized=!0}.bind(this)),t},L.DataLayers=(c={},(d={}).get=function(t,e,a){if(t){if(c[t]){if("object"!=typeof e)throw new Error("invalid layout argument for data layer ["+t+"]");return new c[t](e,a)}throw new Error("data layer ["+t+"] not found")}return null},d.set=function(t,e){if(e){if("function"!=typeof e)throw new Error("unable to set data layer ["+t+"], argument provided is not a function");c[t]=e,c[t].prototype=new L.DataLayer}else delete c[t]},d.add=function(t,e){if(c[t])throw new Error("data layer already exists with name: "+t);d.set(t,e)},d.extend=function(t,e,a){a=a||{};var i=c[t];if(!i)throw new Error("Attempted to subclass an unknown or unregistered datalayer type");if("object"!=typeof a)throw new Error("Must specify an object of properties and methods");var s=L.subclass(i,a);return c[e]=s},d.list=function(){return Object.keys(c)},d),L.DataLayers.add("annotation_track",function(t){if(this.DefaultLayout={color:"#000000",filters:[],tooltip_positioning:"vertical",hitarea_width:8},t=L.Layouts.merge(t,this.DefaultLayout),!Array.isArray(t.filters))throw new Error("Annotation track must specify array of filters for selecting points to annotate");return L.DataLayer.apply(this,arguments),this.render=function(){var o=this,r=this.filter(this.layout.filters,"elements"),t=this.svg.group.select("g.lz-data_layer-"+o.layout.type+"-visible_lines");0===t.size()&&(t=this.svg.group.append("g").attr("class","lz-data_layer-"+o.layout.type+"-visible_lines"));var e=t.selectAll("rect.lz-data_layer-"+o.layout.type).data(r,function(t){return t[o.layout.id_field]});e.enter().append("rect").attr("class","lz-data_layer-"+this.layout.type).attr("id",function(t){return o.getElementId(t)});e.attr("x",function(t){return o.parent.x_scale(t[o.layout.x_axis.field])-.5}).attr("width",1).attr("height",o.parent.layout.height).attr("fill",function(t,e){return o.resolveScalableParameter(o.layout.color,t,e)}),e.exit().remove();var a=this.svg.group.select("g.lz-data_layer-"+o.layout.type+"-hit_areas");0===a.size()&&(a=this.svg.group.append("g").attr("class","lz-data_layer-"+o.layout.type+"-hit_areas"));var i=a.selectAll("rect.lz-data_layer-"+o.layout.type).data(r,function(t){return t[o.layout.id_field]});i.enter().append("rect").attr("class","lz-data_layer-"+this.layout.type).attr("id",function(t){return o.getElementId(t)});var s=function(t,e){var a=o.parent.x_scale(t[o.layout.x_axis.field]),i=a-o.layout.hitarea_width/2;if(1<=e){var s=r[e-1],n=o.parent.x_scale(s[o.layout.x_axis.field]);i=Math.max(i,(a+n)/2)}return[i,a]};i.attr("height",o.parent.layout.height).attr("opacity",0).attr("x",function(t,e){return s(t,e)[0]}).attr("width",function(t,e){var a=s(t,e);return a[1]-a[0]+o.layout.hitarea_width/2}),i.exit().remove(),this.applyBehaviors(i)},this._getTooltipPosition=function(t){var e=this.parent,a=e.layout.height-(e.layout.margin.top+e.layout.margin.bottom),i=e.x_scale(t.data[this.layout.x_axis.field]),s=a/2;return{x_min:i-1,x_max:i+1,y_min:s-e.layout.margin.top,y_max:s+e.layout.margin.bottom}},this}),L.DataLayers.add("arcs",function(t){return this.DefaultLayout={color:"seagreen",hitarea_width:"10px",style:{fill:"none","stroke-width":"1px","stroke-opacity":"100%"},tooltip_positioning:"top"},t=L.Layouts.merge(t,this.DefaultLayout),L.DataLayer.apply(this,arguments),this.render=function(){var a=this,n=a.layout,o=a.parent.x_scale,r=a.parent["y"+n.y_axis.axis+"_scale"],t=n.filters||[],e=this.filter(t,"elements");function i(t){var e=t[n.x_axis.field1],a=t[n.x_axis.field2],i=(e+a)/2,s=[[o(e),r(0)],[o(i),r(t[n.y_axis.field])],[o(a),r(0)]];return g.svg.line().interpolate("monotone").x(function(t){return t[0]}).y(function(t){return t[1]})(s)}var s=this.svg.group.selectAll("path.lz-data_layer-arcs").data(e,function(t){return a.getElementId(t)}),l=this.svg.group.selectAll("path.lz-data_layer-arcs-hitarea").data(e,function(t){return a.getElementId(t)});return s.enter().append("path").attr("class","lz-data_layer-arcs").attr("id",function(t){return a.getElementId(t)}),l.enter().append("path").attr("class","lz-data_layer-arcs-hitarea").attr("id",function(t){return a.getElementId(t)}),s.style(n.style).attr("stroke",function(t,e){return a.resolveScalableParameter(a.layout.color,t,e)}).attr("d",function(t,e){return i(t)}),l.style({fill:"none","stroke-width":n.hitarea_width,"stroke-opacity":0,stroke:"transparent"}).attr("d",function(t,e){return i(t)}),s.exit().remove(),l.exit().remove(),this.applyBehaviors(l),this},this._getTooltipPosition=function(t){var e=this.parent,a=this.layout,i=t.data[a.x_axis.field1],s=t.data[a.x_axis.field2],n=e["y"+a.y_axis.axis+"_scale"];return{x_min:e.x_scale(Math.min(i,s)),x_max:e.x_scale(Math.max(i,s)),y_min:n(t.data[a.y_axis.field]),y_max:n(0)}},this}),L.DataLayers.add("forest",function(t){return this.DefaultLayout={point_size:40,point_shape:"square",color:"#888888",fill_opacity:1,y_axis:{axis:2},id_field:"id",confidence_intervals:{start_field:"ci_start",end_field:"ci_end"},show_no_significance_line:!0},t=L.Layouts.merge(t,this.DefaultLayout),L.DataLayer.apply(this,arguments),this._getTooltipPosition=function(t){var e=this.parent.x_scale(t.data[this.layout.x_axis.field]),a="y"+this.layout.y_axis.axis+"_scale",i=this.parent[a](t.data[this.layout.y_axis.field]),s=this.resolveScalableParameter(this.layout.point_size,t.data),n=Math.sqrt(s/Math.PI);return{x_min:e-n,x_max:e+n,y_min:i-n,y_max:i+n}},this.render=function(){var i="x_scale",s="y"+this.layout.y_axis.axis+"_scale";if(this.layout.confidence_intervals&&-1!==this.layout.fields.indexOf(this.layout.confidence_intervals.start_field)&&-1!==this.layout.fields.indexOf(this.layout.confidence_intervals.end_field)){var t=this.svg.group.selectAll("rect.lz-data_layer-forest.lz-data_layer-forest-ci").data(this.data,function(t){return t[this.layout.id_field]}.bind(this));t.enter().append("rect").attr("class","lz-data_layer-forest lz-data_layer-forest-ci").attr("id",function(t){return this.getElementId(t)+"_ci"}.bind(this)).attr("transform","translate(0,"+(isNaN(this.parent.layout.height)?0:this.parent.layout.height)+")");var e=function(t){var e=this.parent[i](t[this.layout.confidence_intervals.start_field]),a=this.parent[s](t[this.layout.y_axis.field]);return isNaN(e)&&(e=-1e3),isNaN(a)&&(a=-1e3),"translate("+e+","+a+")"}.bind(this),a=function(t){return this.parent[i](t[this.layout.confidence_intervals.end_field])-this.parent[i](t[this.layout.confidence_intervals.start_field])}.bind(this);t.attr("transform",e).attr("width",a).attr("height",1),t.exit().remove()}var n=this.svg.group.selectAll("path.lz-data_layer-forest.lz-data_layer-forest-point").data(this.data,function(t){return t[this.layout.id_field]}.bind(this)),o=isNaN(this.parent.layout.height)?0:this.parent.layout.height;n.enter().append("path").attr("class","lz-data_layer-forest lz-data_layer-forest-point").attr("id",function(t){return this.getElementId(t)}.bind(this)).attr("transform","translate(0,"+o+")");var r=function(t){var e=this.parent[i](t[this.layout.x_axis.field]),a=this.parent[s](t[this.layout.y_axis.field]);return isNaN(e)&&(e=-1e3),isNaN(a)&&(a=-1e3),"translate("+e+","+a+")"}.bind(this),l=function(t,e){return this.resolveScalableParameter(this.layout.color,t,e)}.bind(this),h=function(t,e){return this.resolveScalableParameter(this.layout.fill_opacity,t,e)}.bind(this),u=g.svg.symbol().size(function(t,e){return this.resolveScalableParameter(this.layout.point_size,t,e)}.bind(this)).type(function(t,e){return this.resolveScalableParameter(this.layout.point_shape,t,e)}.bind(this));n.attr("transform",r).attr("fill",l).attr("fill-opacity",h).attr("d",u),n.exit().remove(),n.on("click.event_emitter",function(t){this.parent.emit("element_clicked",t,!0)}.bind(this)),this.applyBehaviors(n)},this}),L.DataLayers.extend("forest","category_forest",{_getDataExtent:function(t,e){var a=this.layout.confidence_intervals;if(a&&-1!==this.layout.fields.indexOf(a.start_field)&&-1!==this.layout.fields.indexOf(a.end_field)){return[g.min(t,function(t){return+new L.Data.Field(a.start_field).resolve(t)}),g.max(t,function(t){return+new L.Data.Field(a.end_field).resolve(t)})]}return L.DataLayer.prototype._getDataExtent.call(this,t,e)},getTicks:function(t,e){if(-1===["x","y1","y2"].indexOf(t))throw new Error("Invalid dimension identifier"+t);if(t==="y"+this.layout.y_axis.axis){var a=this.layout.y_axis.category_field;if(!a)throw new Error("Layout for "+this.layout.id+" must specify category_field");return this.data.map(function(t,e){return{y:e+1,text:t[a]}})}return[]},applyCustomDataMethods:function(){var a=this.layout.y_axis.field;if(!a)throw new Error("Layout for "+this.layout.id+" must specify yaxis.field");return this.data=this.data.map(function(t,e){return t[a]=e+1,t}),this.layout.y_axis.floor=0,this.layout.y_axis.ceiling=this.data.length+1,this}}),L.DataLayers.add("genes",function(t){return this.DefaultLayout={stroke:"rgb(54, 54, 150)",color:"#363696",label_font_size:12,label_exon_spacing:4,exon_height:16,bounding_box_padding:6,track_vertical_spacing:10,tooltip_positioning:"top"},t=L.Layouts.merge(t,this.DefaultLayout),L.DataLayer.apply(this,arguments),this.getElementStatusNodeId=function(t){return this.getElementId(t)+"-statusnode"},this.getTrackHeight=function(){return 2*this.layout.bounding_box_padding+this.layout.label_font_size+this.layout.label_exon_spacing+this.layout.exon_height+this.layout.track_vertical_spacing},this.transcript_idx=0,this.tracks=1,this.gene_track_index={1:[]},this.assignTracks=function(){return this.getLabelWidth=function(t,e){try{var a=this.svg.group.append("text").attr("x",0).attr("y",0).attr("class","lz-data_layer-genes lz-label").style("font-size",e).text(t+"→"),i=a.node().getBBox().width;return a.remove(),i}catch(t){return 0}},this.tracks=1,this.gene_track_index={1:[]},this.data.map(function(t,i){if(this.data[i].gene_id&&this.data[i].gene_id.indexOf(".")){var e=this.data[i].gene_id.split(".");this.data[i].gene_id=e[0],this.data[i].gene_version=e[1]}if(this.data[i].transcript_id=this.data[i].transcripts[this.transcript_idx].transcript_id,this.data[i].display_range={start:this.parent.x_scale(Math.max(t.start,this.state.start)),end:this.parent.x_scale(Math.min(t.end,this.state.end))},this.data[i].display_range.label_width=this.getLabelWidth(this.data[i].gene_name,this.layout.label_font_size),this.data[i].display_range.width=this.data[i].display_range.end-this.data[i].display_range.start,this.data[i].display_range.text_anchor="middle",this.data[i].display_range.width<this.data[i].display_range.label_width){if(t.start<this.state.start)this.data[i].display_range.end=this.data[i].display_range.start+this.data[i].display_range.label_width+this.layout.label_font_size,this.data[i].display_range.text_anchor="start";else if(t.end>this.state.end)this.data[i].display_range.start=this.data[i].display_range.end-this.data[i].display_range.label_width-this.layout.label_font_size,this.data[i].display_range.text_anchor="end";else{var a=(this.data[i].display_range.label_width-this.data[i].display_range.width)/2+this.layout.label_font_size;this.data[i].display_range.start-a<this.parent.x_scale(this.state.start)?(this.data[i].display_range.start=this.parent.x_scale(this.state.start),this.data[i].display_range.end=this.data[i].display_range.start+this.data[i].display_range.label_width,this.data[i].display_range.text_anchor="start"):this.data[i].display_range.end+a>this.parent.x_scale(this.state.end)?(this.data[i].display_range.end=this.parent.x_scale(this.state.end),this.data[i].display_range.start=this.data[i].display_range.end-this.data[i].display_range.label_width,this.data[i].display_range.text_anchor="end"):(this.data[i].display_range.start-=a,this.data[i].display_range.end+=a)}this.data[i].display_range.width=this.data[i].display_range.end-this.data[i].display_range.start}this.data[i].display_range.start-=this.layout.bounding_box_padding,this.data[i].display_range.end+=this.layout.bounding_box_padding,this.data[i].display_range.width+=2*this.layout.bounding_box_padding,this.data[i].display_domain={start:this.parent.x_scale.invert(this.data[i].display_range.start),end:this.parent.x_scale.invert(this.data[i].display_range.end)},this.data[i].display_domain.width=this.data[i].display_domain.end-this.data[i].display_domain.start,this.data[i].track=null;for(var s=1;null===this.data[i].track;){var n=!1;this.gene_track_index[s].map(function(t){if(!n){var e=Math.min(t.display_range.start,this.display_range.start);Math.max(t.display_range.end,this.display_range.end)-e<t.display_range.width+this.display_range.width&&(n=!0)}}.bind(this.data[i])),n?++s>this.tracks&&(this.tracks=s,this.gene_track_index[s]=[]):(this.data[i].track=s,this.gene_track_index[s].push(this.data[i]))}(this.data[i].parent=this).data[i].transcripts.map(function(t,a){this.data[i].transcripts[a].parent=this.data[i],this.data[i].transcripts[a].exons.map(function(t,e){this.data[i].transcripts[a].exons[e].parent=this.data[i].transcripts[a]}.bind(this))}.bind(this))}.bind(this)),this},this.render=function(){var r,l,h,u,d=this;this.assignTracks();var t=this.svg.group.selectAll("g.lz-data_layer-genes").data(this.data,function(t){return t.gene_name});t.enter().append("g").attr("class","lz-data_layer-genes"),t.attr("id",function(t){return this.getElementId(t)}.bind(this)).each(function(t){var e=t.parent,a=g.select(this).selectAll("rect.lz-data_layer-genes.lz-data_layer-genes-statusnode").data([t],function(t){return e.getElementStatusNodeId(t)});a.enter().append("rect").attr("class","lz-data_layer-genes lz-data_layer-genes-statusnode"),a.attr("id",function(t){return e.getElementStatusNodeId(t)}).attr("rx",function(){return e.layout.bounding_box_padding}).attr("ry",function(){return e.layout.bounding_box_padding}),r=function(t){return t.display_range.width},l=function(){return e.getTrackHeight()-e.layout.track_vertical_spacing},h=function(t){return t.display_range.start},u=function(t){return(t.track-1)*e.getTrackHeight()},a.attr("width",r).attr("height",l).attr("x",h).attr("y",u),a.exit().remove();var i=g.select(this).selectAll("rect.lz-data_layer-genes.lz-boundary").data([t],function(t){return t.gene_name+"_boundary"}).style({fill:function(t,e){return d.resolveScalableParameter(d.layout.color,t,e)},stroke:function(t,e){return d.resolveScalableParameter(d.layout.stroke,t,e)}});i.enter().append("rect").attr("class","lz-data_layer-genes lz-boundary"),r=function(t){return e.parent.x_scale(t.end)-e.parent.x_scale(t.start)},l=function(){return 1},h=function(t){return e.parent.x_scale(t.start)},u=function(t){return(t.track-1)*e.getTrackHeight()+e.layout.bounding_box_padding+e.layout.label_font_size+e.layout.label_exon_spacing+Math.max(e.layout.exon_height,3)/2},i.attr("width",r).attr("height",l).attr("x",h).attr("y",u),i.exit().remove();var s=g.select(this).selectAll("text.lz-data_layer-genes.lz-label").data([t],function(t){return t.gene_name+"_label"});s.enter().append("text").attr("class","lz-data_layer-genes lz-label"),s.attr("text-anchor",function(t){return t.display_range.text_anchor}).text(function(t){return"+"===t.strand?t.gene_name+"→":"←"+t.gene_name}).style("font-size",t.parent.layout.label_font_size),h=function(t){return"middle"===t.display_range.text_anchor?t.display_range.start+t.display_range.width/2:"start"===t.display_range.text_anchor?t.display_range.start+e.layout.bounding_box_padding:"end"===t.display_range.text_anchor?t.display_range.end-e.layout.bounding_box_padding:void 0},u=function(t){return(t.track-1)*e.getTrackHeight()+e.layout.bounding_box_padding+e.layout.label_font_size},s.attr("x",h).attr("y",u),s.exit().remove();var n=g.select(this).selectAll("rect.lz-data_layer-genes.lz-exon").data(t.transcripts[t.parent.transcript_idx].exons,function(t){return t.exon_id});n.enter().append("rect").attr("class","lz-data_layer-genes lz-exon"),n.style({fill:function(t,e){return d.resolveScalableParameter(d.layout.color,t.parent.parent,e)},stroke:function(t,e){return d.resolveScalableParameter(d.layout.stroke,t.parent.parent,e)}}),r=function(t){return e.parent.x_scale(t.end)-e.parent.x_scale(t.start)},l=function(){return e.layout.exon_height},h=function(t){return e.parent.x_scale(t.start)},u=function(){return(t.track-1)*e.getTrackHeight()+e.layout.bounding_box_padding+e.layout.label_font_size+e.layout.label_exon_spacing},n.attr("width",r).attr("height",l).attr("x",h).attr("y",u),n.exit().remove();var o=g.select(this).selectAll("rect.lz-data_layer-genes.lz-clickarea").data([t],function(t){return t.gene_name+"_clickarea"});o.enter().append("rect").attr("class","lz-data_layer-genes lz-clickarea"),o.attr("id",function(t){return e.getElementId(t)+"_clickarea"}).attr("rx",function(){return e.layout.bounding_box_padding}).attr("ry",function(){return e.layout.bounding_box_padding}),r=function(t){return t.display_range.width},l=function(){return e.getTrackHeight()-e.layout.track_vertical_spacing},h=function(t){return t.display_range.start},u=function(t){return(t.track-1)*e.getTrackHeight()},o.attr("width",r).attr("height",l).attr("x",h).attr("y",u),o.exit().remove(),o.on("click.event_emitter",function(t){t.parent.parent.emit("element_clicked",t,!0)}),e.applyBehaviors(o)}),t.exit().remove()},this._getTooltipPosition=function(t){var e=this.getElementStatusNodeId(t.data),a=g.select("#"+e).node().getBBox();return{x_min:this.parent.x_scale(t.data.start),x_max:this.parent.x_scale(t.data.end),y_min:a.y,y_max:a.y+a.height}},this}),L.DataLayers.add("line",function(t){if(this.DefaultLayout={style:{fill:"none","stroke-width":"2px"},interpolate:"linear",x_axis:{field:"x"},y_axis:{field:"y",axis:1},hitarea_width:5},(t=L.Layouts.merge(t,this.DefaultLayout)).tooltip)throw new Error("The line / filled curve layer does not support tooltips");return L.DataLayer.apply(this,arguments),this.render=function(){var t,e=this.parent,a=this.layout.x_axis.field,i=this.layout.y_axis.field,s="x_scale",n="y"+this.layout.y_axis.axis+"_scale",o=this.svg.group.selectAll("path.lz-data_layer-line").data([this.data]);this.path=o.enter().append("path").attr("class","lz-data_layer-line"),t=this.layout.style.fill&&"none"!==this.layout.style.fill?g.svg.area().x(function(t){return parseFloat(e[s](t[a]))}).y0(function(t){return parseFloat(e[n](0))}).y1(function(t){return parseFloat(e[n](t[i]))}):g.svg.line().x(function(t){return parseFloat(e[s](t[a]))}).y(function(t){return parseFloat(e[n](t[i]))}).interpolate(this.layout.interpolate),o.attr("d",t).style(this.layout.style),o.exit().remove()},this.setElementStatus=function(t,e,a){return this.setAllElementStatus(t,a)},this.setElementStatusByFilters=function(t,e){return this.setAllElementStatus(t,e)},this.setAllElementStatus=function(t,e){if(void 0===t||-1===L.DataLayer.Statuses.adjectives.indexOf(t))throw new Error("Invalid status passed to DataLayer.setAllElementStatus()");if(void 0===this.layer_state.status_flags[t])return this;void 0===e&&(e=!0),this.global_statuses[t]=e;var a="lz-data_layer-line";return Object.keys(this.global_statuses).forEach(function(t){this.global_statuses[t]&&(a+=" lz-data_layer-line-"+t)}.bind(this)),this.path.attr("class",a),this.parent.emit("layout_changed",!0),this},this}),L.DataLayers.add("orthogonal_line",function(t){return this.DefaultLayout={style:{stroke:"#D3D3D3","stroke-width":"3px","stroke-dasharray":"10px 10px"},orientation:"horizontal",x_axis:{axis:1,decoupled:!0},y_axis:{axis:1,decoupled:!0},tooltip_positioning:"vertical",offset:0},t=L.Layouts.merge(t,this.DefaultLayout),-1===["horizontal","vertical"].indexOf(t.orientation)&&(t.orientation="horizontal"),this.data=[],L.DataLayer.apply(this,arguments),this.getElementId=function(t){return this.getBaseId()},this.render=function(){var i=this.parent,s="y"+this.layout.y_axis.axis+"_scale",t="x_extent",e="y"+this.layout.y_axis.axis+"_extent";if("horizontal"===this.layout.orientation)this.data=[{x:i[t][0],y:this.layout.offset},{x:i[t][1],y:this.layout.offset}];else{if("vertical"!==this.layout.orientation)throw new Error('Unrecognized vertical line type. Must be "vertical" or "horizontal"');this.data=[{x:this.layout.offset,y:i[e][0]},{x:this.layout.offset,y:i[e][1]}]}var a=this.svg.group.selectAll("path.lz-data_layer-line").data([this.data]);this.path=a.enter().append("path").attr("class","lz-data_layer-line");var n=[i.layout.cliparea.height,0],o=g.svg.line().x(function(t,e){var a=parseFloat(i.x_scale(t.x));return isNaN(a)?i.x_range[e]:a}).y(function(t,e){var a=parseFloat(i[s](t.y));return isNaN(a)?n[e]:a}).interpolate("linear");a.attr("d",o).style(this.layout.style),a.exit().remove(),this.applyBehaviors(a)},this._getTooltipPosition=function(t){try{var e=g.mouse(this.svg.container.node()),a=e[0],i=e[1];return{x_min:a-1,x_max:a+1,y_min:i-1,y_max:i+1}}catch(t){return null}},this}),L.DataLayers.add("scatter",function(t){return this.DefaultLayout={point_size:40,point_shape:"circle",tooltip_positioning:"horizontal",color:"#888888",fill_opacity:1,y_axis:{axis:1},id_field:"id"},(t=L.Layouts.merge(t,this.DefaultLayout)).label&&isNaN(t.label.spacing)&&(t.label.spacing=4),L.DataLayer.apply(this,arguments),this._getTooltipPosition=function(t){var e=this.parent.x_scale(t.data[this.layout.x_axis.field]),a="y"+this.layout.y_axis.axis+"_scale",i=this.parent[a](t.data[this.layout.y_axis.field]),s=this.resolveScalableParameter(this.layout.point_size,t.data),n=Math.sqrt(s/Math.PI);return{x_min:e-n,x_max:e+n,y_min:i-n,y_max:i+n}},this.flip_labels=function(){var n=this,o=n.resolveScalableParameter(n.layout.point_size,{}),r=n.layout.label.spacing,l=Boolean(n.layout.label.lines),h=2*r,s=n.parent.layout.width-n.parent.layout.margin.left-n.parent.layout.margin.right-2*r,u=function(t,e){var a=+t.attr("x"),i=2*r+2*Math.sqrt(o);if(l)var s=+e.attr("x2"),n=r+2*Math.sqrt(o);"start"===t.style("text-anchor")?(t.style("text-anchor","end"),t.attr("x",a-i),l&&e.attr("x2",s-n)):(t.style("text-anchor","start"),t.attr("x",a+i),l&&e.attr("x2",s+n))};n.label_texts.each(function(t,e){var a=g.select(this);if(+a.attr("x")+a.node().getBoundingClientRect().width+r>s){var i=l?g.select(n.label_lines[0][e]):null;u(a,i)}}),n.label_texts.each(function(t,e){var a=g.select(this);if("end"!==a.style("text-anchor")){a.attr("x");var i=a.node().getBoundingClientRect(),s=l?g.select(n.label_lines[0][e]):null;n.label_texts.each(function(){var t=g.select(this).node().getBoundingClientRect();i.left<t.left+t.width+2*r&&i.left+i.width+2*r>t.left&&i.top<t.top+t.height+2*r&&i.height+i.top+2*r>t.top&&(u(a,s),+a.attr("x")-i.width-r<h&&u(a,s))})}})},this.separate_labels=function(){this.seperate_iterations++;var p=this;if(this.layout.label){var y=this.layout.label.spacing,_=!1;if(p.label_texts.each(function(){var u=this,d=g.select(u),c=d.attr("y");p.label_texts.each(function(){if(u!==this){var t=g.select(this);if(d.attr("text-anchor")===t.attr("text-anchor")){var e=d.node().getBoundingClientRect(),a=t.node().getBoundingClientRect();if(e.left<a.left+a.width+2*y&&e.left+e.width+2*y>a.left&&e.top<a.top+a.height+2*y&&e.height+e.top+2*y>a.top){_=!0;var i,s=t.attr("y"),n=.5*(e.top<a.top?1:-1),o=+c-n,r=+s+n,l=2*y,h=p.parent.layout.height-p.parent.layout.margin.top-p.parent.layout.margin.bottom-2*y;o-e.height/2<l?(i=+c-o,o=+c,r+=i):r-a.height/2<l&&(i=+s-r,r=+s,o+=i),o+e.height/2>h?(i=o-+c,o=+c,r-=i):r+a.height/2>h&&(i=r-+s,r=+s,o-=i),d.attr("y",o),t.attr("y",r)}}}})}),_){if(p.layout.label.lines){var a=p.label_texts[0];p.label_lines.attr("y2",function(t,e){return g.select(a[e]).attr("y")})}this.seperate_iterations<150&&setTimeout(function(){this.separate_labels()}.bind(this),1)}}},this.render=function(){var n=this,a=this,i="x_scale",s="y"+this.layout.y_axis.axis+"_scale";if(this.layout.label){var t,e=a.layout.label.filters||[];t=e.length?this.data.filter(function(i){var s=!0;return e.forEach(function(t){var e=n.layer_state.extra_fields[n.getElementId(i)],a=new L.Data.Field(t.field).resolve(i,e);if(-1===["!=","="].indexOf(t.operator)&&isNaN(a))s=!1;else switch(t.operator){case"<":a<t.value||(s=!1);break;case"<=":a<=t.value||(s=!1);break;case">":a>t.value||(s=!1);break;case">=":a>=t.value||(s=!1);break;case"=":a!==t.value&&(s=!1);break;case"!=":a==t.value&&(s=!1);break;default:s=!1}}),s}):this.data,this.label_groups=this.svg.group.selectAll("g.lz-data_layer-"+this.layout.type+"-label").data(t,function(t){return t[n.layout.id_field]+"_label"}),this.label_groups.enter().append("g").attr("class","lz-data_layer-"+this.layout.type+"-label"),this.label_texts&&this.label_texts.remove(),this.label_texts=this.label_groups.append("text").attr("class","lz-data_layer-"+this.layout.type+"-label"),this.label_texts.text(function(t){return L.parseFields(t,a.layout.label.text||"")}).style(a.layout.label.style||{}).attr({x:function(t){var e=a.parent[i](t[a.layout.x_axis.field])+Math.sqrt(a.resolveScalableParameter(a.layout.point_size,t))+a.layout.label.spacing;return isNaN(e)&&(e=-1e3),e},y:function(t){var e=a.parent[s](t[a.layout.y_axis.field]);return isNaN(e)&&(e=-1e3),e},"text-anchor":function(){return"start"}}),a.layout.label.lines&&(this.label_lines&&this.label_lines.remove(),this.label_lines=this.label_groups.append("line").attr("class","lz-data_layer-"+this.layout.type+"-label"),this.label_lines.style(a.layout.label.lines.style||{}).attr({x1:function(t){var e=a.parent[i](t[a.layout.x_axis.field]);return isNaN(e)&&(e=-1e3),e},y1:function(t){var e=a.parent[s](t[a.layout.y_axis.field]);return isNaN(e)&&(e=-1e3),e},x2:function(t){var e=a.parent[i](t[a.layout.x_axis.field])+Math.sqrt(a.resolveScalableParameter(a.layout.point_size,t))+a.layout.label.spacing/2;return isNaN(e)&&(e=-1e3),e},y2:function(t){var e=a.parent[s](t[a.layout.y_axis.field]);return isNaN(e)&&(e=-1e3),e}})),this.label_groups.exit().remove()}else this.label_groups&&this.label_groups.remove(),this.label_lines&&this.label_lines.remove();var o=this.svg.group.selectAll("path.lz-data_layer-"+this.layout.type).data(this.data,function(t){return t[n.layout.id_field]}),r=isNaN(this.parent.layout.height)?0:this.parent.layout.height;o.enter().append("path").attr("class","lz-data_layer-"+this.layout.type).attr("id",function(t){return n.getElementId(t)}).attr("transform","translate(0,"+r+")");var l=function(t,e){return this.resolveScalableParameter(this.layout.color,t,e)}.bind(this),h=function(t,e){return this.resolveScalableParameter(this.layout.fill_opacity,t,e)}.bind(this),u=g.svg.symbol().size(function(t,e){return this.resolveScalableParameter(this.layout.point_size,t,e)}.bind(this)).type(function(t,e){return this.resolveScalableParameter(this.layout.point_shape,t,e)}.bind(this));o.attr("transform",function(t){var e=n.parent[i](t[n.layout.x_axis.field]),a=n.parent[s](t[n.layout.y_axis.field]);return isNaN(e)&&(e=-1e3),isNaN(a)&&(a=-1e3),"translate("+e+","+a+")"}).attr("fill",l).attr("fill-opacity",h).attr("d",u),o.exit().remove(),o.on("click.event_emitter",function(t){n.parent.emit("element_clicked",t,!0)}),this.applyBehaviors(o),this.layout.label&&(this.flip_labels(),this.seperate_iterations=0,this.separate_labels(),this.label_texts.on("click.event_emitter",function(t){n.parent.emit("element_clicked",t,!0)}),this.applyBehaviors(this.label_texts))},this.makeLDReference=function(t){var e=null;if(void 0===t)throw new Error("makeLDReference requires one argument of any type");e="object"==typeof t?this.layout.id_field&&void 0!==t[this.layout.id_field]?t[this.layout.id_field].toString():void 0!==t.id?t.id.toString():t.toString():t.toString(),this.parent_plot.applyState({ldrefvar:e})},this}),L.DataLayers.extend("scatter","category_scatter",{_prepareData:function(){var a=this.layout.x_axis.field||"x",o=this.layout.x_axis.category_field;if(!o)throw new Error("Layout for "+this.layout.id+" must specify category_field");var t=this.data.sort(function(t,e){var a=t[o],i=e[o],s="string"==typeof a?a.toLowerCase():a,n="string"==typeof i?i.toLowerCase():i;return s===n?0:s<n?-1:1});return t.forEach(function(t,e){t[a]=t[a]||e}),t},_generateCategoryBounds:function(){var s=this.layout.x_axis.category_field,n=this.layout.x_axis.field||"x",o={};this.data.forEach(function(t){var e=t[s],a=t[n],i=o[e]||[a,a];o[e]=[Math.min(i[0],a),Math.max(i[1],a)]});var t=Object.keys(o);return this._setDynamicColorScheme(t),o},_getColorScale:function(t){var e=(t=t||this.layout).color||[];if(Array.isArray(e)&&(e=e.find(function(t){return"categorical_bin"===t.scale_function})),!e||"categorical_bin"!==e.scale_function)throw new Error("This layer requires that color options be provided as a `categorical_bin`");return e},_setDynamicColorScheme:function(t){var e,a=this._getColorScale(this.layout).parameters,i=this._getColorScale(this._base_layout).parameters;if(i.categories.length&&i.values.length){var s={};i.categories.forEach(function(t){s[t]=1}),t.every(function(t){return s.hasOwnProperty(t)})?a.categories=i.categories:a.categories=t}else a.categories=t;i.values.length?e=i.values:e=(t.length<=10?g.scale.category10:g.scale.category20)().range();for(;e.length<t.length;)e=e.concat(e);e=e.slice(0,t.length),a.values=e},getTicks:function(t,e){if(-1===["x","y1","y2"].indexOf(t))throw new Error("Invalid dimension identifier");var n=e.position||"left";if(-1===["left","center","right"].indexOf(n))throw new Error("Invalid tick position");var o=this._categories;if(!o||!Object.keys(o).length)return[];if("y"===t)return[];if("x"===t){var a=this._getColorScale(this.layout),r=a.parameters.categories||[],l=a.parameters.values||[];return Object.keys(o).map(function(t,e){var a,i=o[t];switch(n){case"left":a=i[0];break;case"center":var s=i[1]-i[0];a=i[0]+(0!==s?s:i[0])/2;break;case"right":a=i[1]}return{x:a,text:t,style:{fill:l[r.indexOf(t)]||"#000000"}}})}},applyCustomDataMethods:function(){return this.data=this._prepareData(),this._categories=this._generateCategoryBounds(),this}}),L.KnownDataSources=(h=[],u=function(t){for(var e=0;e<h.length;e++){if(!h[e].SOURCE_NAME)throw new Error("KnownDataSources at position "+e+" does not have a 'SOURCE_NAME' static property");if(h[e].SOURCE_NAME===t)return h[e]}return null},(e={}).get=function(t){return u(t)},e.add=function(t){t.SOURCE_NAME||console.warn("Data source added does not have a SOURCE_NAME"),h.push(t)},e.extend=function(t,e,a){var i=u(t);if(!i)throw new Error("Attempted to subclass an unknown or unregistered data source");if(!e)throw new Error("Must provide a name for the new data source");if("object"!=typeof a)throw new Error("Must specify an object of properties and methods");var s=L.subclass(i,a);return s.SOURCE_NAME=e,h.push(s),s},e.push=function(t){console.warn("Warning: KnownDataSources.push() is deprecated. Use .add() instead"),e.add(t)},e.list=function(){return h.map(function(t){return t.SOURCE_NAME})},e.create=function(t){var e=u(t);if(e){var a=arguments;return a[0]=null,new(Function.prototype.bind.apply(e,a))}throw new Error("Unable to find data source for name: "+t)},e.getAll=function(){return h},e.setAll=function(t){h=t},e.clear=function(){h=[]},e),L.TransformationFunctions=(r={},l=function(t){return function(t){if(!t)return null;var e=r[t];if(e)return e;throw new Error("transformation "+t+" not found")}(t)},(o={}).get=function(t){return t&&"|"===t.substring(0,1)?function(t){for(var e,i=[],a=/\|([^|]+)/g;null!==(e=a.exec(t));)i.push(e[1]);return 1===i.length?l(i[0]):1<i.length?function(t){for(var e=t,a=0;a<i.length;a++)e=l(i[a])(e);return e}:null}(t):l(t)},o.set=function(t,e){if("|"===t.substring(0,1))throw new Error("transformation name should not start with a pipe");e?r[t]=e:delete r[t]},o.add=function(t,e){if(r[t])throw new Error("transformation already exists with name: "+t);o.set(t,e)},o.list=function(){return Object.keys(r)},o),L.TransformationFunctions.add("neglog10",function(t){return isNaN(t)||t<=0?null:-Math.log(t)/Math.LN10}),L.TransformationFunctions.add("logtoscinotation",function(t){if(isNaN(t))return"NaN";if(0===t)return"1";var e=Math.ceil(t),a=e-t,i=Math.pow(10,a);return 1===e?(i/10).toFixed(4):2===e?(i/100).toFixed(3):i.toFixed(2)+" × 10^-"+e}),L.TransformationFunctions.add("scinotation",function(t){if(isNaN(t))return"NaN";if(0===t)return"0";var e,a=Math.abs(t);return e=1<a?Math.ceil(Math.log(a)/Math.LN10):Math.floor(Math.log(a)/Math.LN10),Math.abs(e)<=3?t.toFixed(3):t.toExponential(2).replace("+","").replace("e"," × 10^")}),L.TransformationFunctions.add("urlencode",function(t){return encodeURIComponent(t)}),L.TransformationFunctions.add("htmlescape",function(t){return t?(t+="").replace(/['"<>&`]/g,function(t){switch(t){case"'":return"&#039;";case'"':return"&quot;";case"<":return"&lt;";case">":return"&gt;";case"&":return"&amp;";case"`":return"&#x60;"}}):""}),L.ScaleFunctions=(n={},(s={}).get=function(t,e,a,i){if(t){if(n[t])return void 0===e&&void 0===a&&void 0===i?n[t]:n[t](e,a,i);throw new Error("scale function ["+t+"] not found")}return null},s.set=function(t,e){e?n[t]=e:delete n[t]},s.add=function(t,e){if(n[t])throw new Error("scale function already exists with name: "+t);s.set(t,e)},s.list=function(){return Object.keys(n)},s),L.ScaleFunctions.add("if",function(t,e){return void 0===e||t.field_value!==e?void 0!==t.else?t.else:null:t.then}),L.ScaleFunctions.add("numerical_bin",function(t,a){var e=t.breaks||[],i=t.values||[];if(null==a||isNaN(+a))return t.null_value?t.null_value:null;var s=e.reduce(function(t,e){return+a<t||t<=+a&&+a<e?t:e});return i[e.indexOf(s)]}),L.ScaleFunctions.add("categorical_bin",function(t,e){return void 0===e||-1===t.categories.indexOf(e)?t.null_value?t.null_value:null:t.values[t.categories.indexOf(e)]}),L.ScaleFunctions.add("ordinal_cycle",function(t,e,a){var i=t.values;return i[a%i.length]}),L.ScaleFunctions.add("interpolate",function(t,a){var i=t.breaks||[],e=t.values||[],s=t.null_value?t.null_value:null;if(i.length<2||i.length!==e.length)return s;if(null==a||isNaN(+a))return s;if(+a<=t.breaks[0])return e[0];if(+a>=t.breaks[t.breaks.length-1])return e[i.length-1];var n=null;if(i.forEach(function(t,e){e&&i[e-1]<=+a&&i[e]>=+a&&(n=e)}),null===n)return s;var o=(+a-i[n-1])/(i[n]-i[n-1]);return isFinite(o)?g.interpolate(e[n-1],e[n])(o):s}),L.Dashboard=function(t){if(!(t instanceof L.Plot||t instanceof L.Panel))throw new Error("Unable to create dashboard, parent must be a locuszoom plot or panel");return this.parent=t,this.id=this.parent.getBaseId()+".dashboard",this.type=this.parent instanceof L.Plot?"plot":"panel",this.parent_plot="plot"===this.type?this.parent:this.parent.parent,this.selector=null,this.components=[],this.hide_timeout=null,this.persist=!1,this.initialize()},L.Dashboard.prototype.initialize=function(){return Array.isArray(this.parent.layout.dashboard.components)&&this.parent.layout.dashboard.components.forEach(function(t){try{var e=L.Dashboard.Components.get(t.type,t,this);this.components.push(e)}catch(t){console.warn(t)}}.bind(this)),"panel"===this.type&&(g.select(this.parent.parent.svg.node().parentNode).on("mouseover."+this.id,function(){clearTimeout(this.hide_timeout),this.selector&&"hidden"!==this.selector.style("visibility")||this.show()}.bind(this)),g.select(this.parent.parent.svg.node().parentNode).on("mouseout."+this.id,function(){clearTimeout(this.hide_timeout),this.hide_timeout=setTimeout(function(){this.hide()}.bind(this),300)}.bind(this))),this},L.Dashboard.prototype.shouldPersist=function(){if(this.persist)return!0;var e=!1;return this.components.forEach(function(t){e=e||t.shouldPersist()}),!!(e=e||this.parent_plot.panel_boundaries.dragging||this.parent_plot.interaction.dragging)},L.Dashboard.prototype.show=function(){if(!this.selector){switch(this.type){case"plot":this.selector=g.select(this.parent.svg.node().parentNode).insert("div",":first-child");break;case"panel":this.selector=g.select(this.parent.parent.svg.node().parentNode).insert("div",".lz-data_layer-tooltip, .lz-dashboard-menu, .lz-curtain").classed("lz-panel-dashboard",!0)}this.selector.classed("lz-dashboard",!0).classed("lz-"+this.type+"-dashboard",!0).attr("id",this.id)}return this.components.forEach(function(t){t.show()}),this.selector.style({visibility:"visible"}),this.update()},L.Dashboard.prototype.update=function(){return this.selector?(this.components.forEach(function(t){t.update()}),this.position()):this},L.Dashboard.prototype.position=function(){if(!this.selector)return this;if("panel"===this.type){var t=this.parent.getPageOrigin(),e=(t.y+3.5).toString()+"px",a=t.x.toString()+"px",i=(this.parent.layout.width-4).toString()+"px";this.selector.style({position:"absolute",top:e,left:a,width:i})}return this.components.forEach(function(t){t.position()}),this},L.Dashboard.prototype.hide=function(){return!this.selector||this.shouldPersist()||(this.components.forEach(function(t){t.hide()}),this.selector.style({visibility:"hidden"})),this},L.Dashboard.prototype.destroy=function(t){return void 0===t&&(t=!1),this.selector&&(this.shouldPersist()&&!t||(this.components.forEach(function(t){t.destroy(!0)}),this.components=[],this.selector.remove(),this.selector=null)),this},L.Dashboard.Component=function(t,e){return this.layout=t||{},this.layout.color||(this.layout.color="gray"),this.parent=e||null,this.parent_panel=null,this.parent_plot=null,this.parent_svg=null,this.parent instanceof L.Dashboard&&("panel"===this.parent.type?(this.parent_panel=this.parent.parent,this.parent_plot=this.parent.parent.parent,this.parent_svg=this.parent_panel):(this.parent_plot=this.parent.parent,this.parent_svg=this.parent_plot)),this.selector=null,this.button=null,this.persist=!1,this.layout.position||(this.layout.position="left"),this},L.Dashboard.Component.prototype.show=function(){if(this.parent&&this.parent.selector){if(!this.selector){var t=-1!==["start","middle","end"].indexOf(this.layout.group_position)?" lz-dashboard-group-"+this.layout.group_position:"";this.selector=this.parent.selector.append("div").attr("class","lz-dashboard-"+this.layout.position+t),this.layout.style&&this.selector.style(this.layout.style),"function"==typeof this.initialize&&this.initialize()}return this.button&&"highlighted"===this.button.status&&this.button.menu.show(),this.selector.style({visibility:"visible"}),this.update(),this.position()}},L.Dashboard.Component.prototype.update=function(){},L.Dashboard.Component.prototype.position=function(){return this.button&&this.button.menu.position(),this},L.Dashboard.Component.prototype.shouldPersist=function(){return!!this.persist||!(!this.button||!this.button.persist)},L.Dashboard.Component.prototype.hide=function(){return!this.selector||this.shouldPersist()||(this.button&&this.button.menu.hide(),this.selector.style({visibility:"hidden"})),this},L.Dashboard.Component.prototype.destroy=function(t){return void 0===t&&(t=!1),this.selector&&(this.shouldPersist()&&!t||(this.button&&this.button.menu&&this.button.menu.destroy(),this.selector.remove(),this.selector=null,this.button=null)),this},L.Dashboard.Components=(i={},(a={}).get=function(t,e,a){if(t){if(i[t]){if("object"!=typeof e)throw new Error("invalid layout argument for dashboard component ["+t+"]");return new i[t](e,a)}throw new Error("dashboard component ["+t+"] not found")}return null},a.set=function(t,e){if(e){if("function"!=typeof e)throw new Error("unable to set dashboard component ["+t+"], argument provided is not a function");i[t]=e,i[t].prototype=new L.Dashboard.Component}else delete i[t]},a.add=function(t,e){if(i[t])throw new Error("dashboard component already exists with name: "+t);a.set(t,e)},a.list=function(){return Object.keys(i)},a),L.Dashboard.Component.Button=function(t){if(!(t instanceof L.Dashboard.Component))throw new Error("Unable to create dashboard component button, invalid parent");this.parent=t,this.parent_panel=this.parent.parent_panel,this.parent_plot=this.parent.parent_plot,this.parent_svg=this.parent.parent_svg,this.parent_dashboard=this.parent.parent,this.selector=null,this.tag="a",this.setTag=function(t){return void 0!==t&&(this.tag=t.toString()),this},this.html="",this.setHtml=function(t){return void 0!==t&&(this.html=t.toString()),this},this.setText=this.setHtml,this.title="",this.setTitle=function(t){return void 0!==t&&(this.title=t.toString()),this},this.color="gray",this.setColor=function(t){return void 0!==t&&(-1!==["gray","red","orange","yellow","green","blue","purple"].indexOf(t)?this.color=t:this.color="gray"),this},this.style={},this.setStyle=function(t){return void 0!==t&&(this.style=t),this},this.getClass=function(){var t=-1!==["start","middle","end"].indexOf(this.parent.layout.group_position)?" lz-dashboard-button-group-"+this.parent.layout.group_position:"";return"lz-dashboard-button lz-dashboard-button-"+this.color+(this.status?"-"+this.status:"")+t},this.persist=!1,this.permanent=!1,this.setPermanent=function(t){return t=void 0===t||Boolean(t),this.permanent=t,this.permanent&&(this.persist=!0),this},this.shouldPersist=function(){return this.permanent||this.persist},this.status="",this.setStatus=function(t){return void 0!==t&&-1!==["","highlighted","disabled"].indexOf(t)&&(this.status=t),this.update()},this.highlight=function(t){return(t=void 0===t||Boolean(t))?this.setStatus("highlighted"):"highlighted"===this.status?this.setStatus(""):this},this.disable=function(t){return(t=void 0===t||Boolean(t))?this.setStatus("disabled"):"disabled"===this.status?this.setStatus(""):this},this.onmouseover=function(){},this.setOnMouseover=function(t){return this.onmouseover="function"==typeof t?t:function(){},this},this.onmouseout=function(){},this.setOnMouseout=function(t){return this.onmouseout="function"==typeof t?t:function(){},this},this.onclick=function(){},this.setOnclick=function(t){return this.onclick="function"==typeof t?t:function(){},this},this.show=function(){if(this.parent)return this.selector||(this.selector=this.parent.selector.append(this.tag).attr("class",this.getClass())),this.update()},this.preUpdate=function(){return this},this.update=function(){return this.selector&&(this.preUpdate(),this.selector.attr("class",this.getClass()).attr("title",this.title).style(this.style).on("mouseover","disabled"===this.status?null:this.onmouseover).on("mouseout","disabled"===this.status?null:this.onmouseout).on("click","disabled"===this.status?null:this.onclick).html(this.html),this.menu.update(),this.postUpdate()),this},this.postUpdate=function(){return this},this.hide=function(){return this.selector&&!this.shouldPersist()&&(this.selector.remove(),this.selector=null),this},this.menu={outer_selector:null,inner_selector:null,scroll_position:0,hidden:!0,show:function(){return this.menu.outer_selector||(this.menu.outer_selector=g.select(this.parent_plot.svg.node().parentNode).append("div").attr("class","lz-dashboard-menu lz-dashboard-menu-"+this.color).attr("id",this.parent_svg.getBaseId()+".dashboard.menu"),this.menu.inner_selector=this.menu.outer_selector.append("div").attr("class","lz-dashboard-menu-content"),this.menu.inner_selector.on("scroll",function(){this.menu.scroll_position=this.menu.inner_selector.node().scrollTop}.bind(this))),this.menu.outer_selector.style({visibility:"visible"}),this.menu.hidden=!1,this.menu.update()}.bind(this),update:function(){return this.menu.outer_selector?(this.menu.populate(),this.menu.inner_selector&&(this.menu.inner_selector.node().scrollTop=this.menu.scroll_position),this.menu.position()):this.menu}.bind(this),position:function(){if(!this.menu.outer_selector)return this.menu;this.menu.outer_selector.style({height:null});var t=this.parent_svg.getPageOrigin(),e=document.documentElement.scrollTop||document.body.scrollTop,a=this.parent_plot.getContainerOffset(),i=this.parent_dashboard.selector.node().getBoundingClientRect(),s=this.selector.node().getBoundingClientRect(),n=this.menu.outer_selector.node().getBoundingClientRect(),o=this.menu.inner_selector.node().scrollHeight,r=0,l=0;"panel"===this.parent_dashboard.type?(r=t.y+i.height+6,l=Math.max(t.x+this.parent_svg.layout.width-n.width-3,t.x+3)):(r=s.bottom+e+3-a.top,l=Math.max(s.left+s.width-n.width-a.left,t.x+3));var h=Math.max(this.parent_svg.layout.width-6-20,20),u=h,d=h-12,c=Math.max(this.parent_svg.layout.height-30-14,14),p=Math.min(o,c),y=c;return this.menu.outer_selector.style({top:r.toString()+"px",left:l.toString()+"px","max-width":u.toString()+"px","max-height":y.toString()+"px",height:p.toString()+"px"}),this.menu.inner_selector.style({"max-width":d.toString()+"px"}),this.menu.inner_selector.node().scrollTop=this.menu.scroll_position,this.menu}.bind(this),hide:function(){return this.menu.outer_selector&&(this.menu.outer_selector.style({visibility:"hidden"}),this.menu.hidden=!0),this.menu}.bind(this),destroy:function(){return this.menu.outer_selector&&(this.menu.inner_selector.remove(),this.menu.outer_selector.remove(),this.menu.inner_selector=null,this.menu.outer_selector=null),this.menu}.bind(this),populate:function(){}.bind(this),setPopulate:function(t){return"function"==typeof t?(this.menu.populate=t,this.setOnclick(function(){this.menu.hidden?(this.menu.show(),this.highlight().update(),this.persist=!0):(this.menu.hide(),this.highlight(!1).update(),this.permanent||(this.persist=!1))}.bind(this))):this.setOnclick(),this}.bind(this)}},L.Dashboard.Components.add("title",function(e){L.Dashboard.Component.apply(this,arguments),this.show=function(){return this.div_selector||(this.div_selector=this.parent.selector.append("div").attr("class","lz-dashboard-title lz-dashboard-"+this.layout.position),this.title_selector=this.div_selector.append("h3")),this.update()},this.update=function(){var t=e.title.toString();return this.layout.subtitle&&(t+=" <small>"+this.layout.subtitle+"</small>"),this.title_selector.html(t),this}}),L.Dashboard.Components.add("dimensions",function(a){L.Dashboard.Component.apply(this,arguments),this.update=function(){var t=-1===this.parent_plot.layout.width.toString().indexOf(".")?this.parent_plot.layout.width:this.parent_plot.layout.width.toFixed(2),e=-1===this.parent_plot.layout.height.toString().indexOf(".")?this.parent_plot.layout.height:this.parent_plot.layout.height.toFixed(2);return this.selector.html(t+"px × "+e+"px"),a.class&&this.selector.attr("class",a.class),a.style&&this.selector.style(a.style),this}}),L.Dashboard.Components.add("region_scale",function(t){L.Dashboard.Component.apply(this,arguments),this.update=function(){return isNaN(this.parent_plot.state.start)||isNaN(this.parent_plot.state.end)||null===this.parent_plot.state.start||null===this.parent_plot.state.end?this.selector.style("display","none"):(this.selector.style("display",null),this.selector.html(L.positionIntToString(this.parent_plot.state.end-this.parent_plot.state.start,null,!0))),t.class&&this.selector.attr("class",t.class),t.style&&this.selector.style(t.style),this}}),L.Dashboard.Components.add("download",function(a){for(var t in L.Dashboard.Component.apply(this,arguments),this.update=function(){return this.button||(this.button=new L.Dashboard.Component.Button(this).setColor(a.color).setHtml(a.button_html||"Download Image").setTitle(a.button_title||"Download image of the current plot as locuszoom.svg").setOnMouseover(function(){this.button.selector.classed("lz-dashboard-button-gray-disabled",!0).html("Preparing Image"),this.generateBase64SVG().then(function(t){var e=this.button.selector.attr("href");e&&URL.revokeObjectURL(e),this.button.selector.attr("href",t).classed("lz-dashboard-button-gray-disabled",!1).classed("lz-dashboard-button-gray-highlighted",!0).html(a.button_html||"Download Image")}.bind(this))}.bind(this)).setOnMouseout(function(){this.button.selector.classed("lz-dashboard-button-gray-highlighted",!1)}.bind(this)),this.button.show(),this.button.selector.attr("href-lang","image/svg+xml").attr("download",a.filename||"locuszoom.svg")),this},this.css_string="",Object.keys(document.styleSheets))if(null!==document.styleSheets[t].href&&-1!==document.styleSheets[t].href.indexOf("locuszoom.css")){L.createCORSPromise("GET",document.styleSheets[t].href).then(function(t){this.css_string=t.replace(/[\r\n]/g," ").replace(/\s+/g," "),this.css_string.indexOf("/* ! LocusZoom HTML Styles */")&&(this.css_string=this.css_string.substring(0,this.css_string.indexOf("/* ! LocusZoom HTML Styles */")))}.bind(this));break}this.generateBase64SVG=function(){return new Promise(function(t,e){var a=this.parent.selector.append("div").style("display","none").html(this.parent_plot.svg.node().outerHTML);a.selectAll("g.lz-curtain").remove(),a.selectAll("g.lz-mouse_guide").remove(),a.selectAll("g.tick text").each(function(){var t=10*+g.select(this).attr("dy").substring(-2).slice(0,-2);g.select(this).attr("dy",t)});var i=g.select(a.select("svg").node().parentNode).html(),s='<style type="text/css"><![CDATA[ '+this.css_string+" ]]></style>",n=i.indexOf(">")+1;i=i.slice(0,n)+s+i.slice(n),a.remove();var o=new Blob([i],{type:"image/svg+xml"});t(URL.createObjectURL(o))}.bind(this))}}),L.Dashboard.Components.add("remove_panel",function(e){L.Dashboard.Component.apply(this,arguments),this.update=function(){return this.button||(this.button=new L.Dashboard.Component.Button(this).setColor(e.color).setHtml("×").setTitle("Remove panel").setOnclick(function(){if(!e.suppress_confirm&&!confirm("Are you sure you want to remove this panel? This cannot be undone!"))return!1;var t=this.parent_panel;return t.dashboard.hide(!0),g.select(t.parent.svg.node().parentNode).on("mouseover."+t.getBaseId()+".dashboard",null),g.select(t.parent.svg.node().parentNode).on("mouseout."+t.getBaseId()+".dashboard",null),t.parent.removePanel(t.id)}.bind(this)),this.button.show()),this}}),L.Dashboard.Components.add("move_panel_up",function(e){L.Dashboard.Component.apply(this,arguments),this.update=function(){if(this.button){var t=0===this.parent_panel.layout.y_index;return this.button.disable(t),this}return this.button=new L.Dashboard.Component.Button(this).setColor(e.color).setHtml("▴").setTitle("Move panel up").setOnclick(function(){this.parent_panel.moveUp(),this.update()}.bind(this)),this.button.show(),this.update()}}),L.Dashboard.Components.add("move_panel_down",function(e){L.Dashboard.Component.apply(this,arguments),this.update=function(){if(this.button){var t=this.parent_panel.layout.y_index===this.parent_plot.panel_ids_by_y_index.length-1;return this.button.disable(t),this}return this.button=new L.Dashboard.Component.Button(this).setColor(e.color).setHtml("▾").setTitle("Move panel down").setOnclick(function(){this.parent_panel.moveDown(),this.update()}.bind(this)),this.button.show(),this.update()}}),L.Dashboard.Components.add("shift_region",function(t){if(L.Dashboard.Component.apply(this,arguments),isNaN(this.parent_plot.state.start)||isNaN(this.parent_plot.state.end))return this.update=function(){},void console.warn("Unable to add shift_region dashboard component: plot state does not have region bounds");(isNaN(t.step)||0===t.step)&&(t.step=5e4),"string"!=typeof t.button_html&&(t.button_html=0<t.step?">":"<"),"string"!=typeof t.button_title&&(t.button_title="Shift region by "+(0<t.step?"+":"-")+L.positionIntToString(Math.abs(t.step),null,!0)),this.update=function(){return this.button||(this.button=new L.Dashboard.Component.Button(this).setColor(t.color).setHtml(t.button_html).setTitle(t.button_title).setOnclick(function(){this.parent_plot.applyState({start:Math.max(this.parent_plot.state.start+t.step,1),end:this.parent_plot.state.end+t.step})}.bind(this)),this.button.show()),this}}),L.Dashboard.Components.add("zoom_region",function(i){if(L.Dashboard.Component.apply(this,arguments),isNaN(this.parent_plot.state.start)||isNaN(this.parent_plot.state.end))return this.update=function(){},void console.warn("Unable to add zoom_region dashboard component: plot state does not have region bounds");(isNaN(i.step)||0===i.step)&&(i.step=.2),"string"!=typeof i.button_html&&(i.button_html=0<i.step?"z–":"z+"),"string"!=typeof i.button_title&&(i.button_title="Zoom region "+(0<i.step?"out":"in")+" by "+(100*Math.abs(i.step)).toFixed(1)+"%"),this.update=function(){if(this.button){var t=!0,e=this.parent_plot.state.end-this.parent_plot.state.start;return 0<i.step&&!isNaN(this.parent_plot.layout.max_region_scale)&&e>=this.parent_plot.layout.max_region_scale&&(t=!1),i.step<0&&!isNaN(this.parent_plot.layout.min_region_scale)&&e<=this.parent_plot.layout.min_region_scale&&(t=!1),this.button.disable(!t),this}return this.button=new L.Dashboard.Component.Button(this).setColor(i.color).setHtml(i.button_html).setTitle(i.button_title).setOnclick(function(){var t=this.parent_plot.state.end-this.parent_plot.state.start,e=t*(1+i.step);isNaN(this.parent_plot.layout.max_region_scale)||(e=Math.min(e,this.parent_plot.layout.max_region_scale)),isNaN(this.parent_plot.layout.min_region_scale)||(e=Math.max(e,this.parent_plot.layout.min_region_scale));var a=Math.floor((e-t)/2);this.parent_plot.applyState({start:Math.max(this.parent_plot.state.start-a,1),end:this.parent_plot.state.end+a})}.bind(this)),this.button.show(),this}}),L.Dashboard.Components.add("menu",function(t){L.Dashboard.Component.apply(this,arguments),this.update=function(){return this.button||(this.button=new L.Dashboard.Component.Button(this).setColor(t.color).setHtml(t.button_html).setTitle(t.button_title),this.button.menu.setPopulate(function(){this.button.menu.inner_selector.html(t.menu_html)}.bind(this)),this.button.show()),this}}),L.Dashboard.Components.add("resize_to_data",function(t){L.Dashboard.Component.apply(this,arguments),this.update=function(){return this.button||(this.button=new L.Dashboard.Component.Button(this).setColor(t.color).setHtml(t.button_html||"Resize to Data").setTitle(t.button_title||"Automatically resize this panel to show all data available").setOnclick(function(){this.parent_panel.scaleHeightToData(),this.update()}.bind(this)),this.button.show()),this}}),L.Dashboard.Components.add("toggle_legend",function(e){L.Dashboard.Component.apply(this,arguments),this.update=function(){var t=this.parent_panel.legend.layout.hidden?"Show Legend":"Hide Legend";return this.button?(this.button.setHtml(t).show(),this.parent.position(),this):(this.button=new L.Dashboard.Component.Button(this).setColor(e.color).setTitle("Show or hide the legend for this panel").setOnclick(function(){this.parent_panel.legend.layout.hidden=!this.parent_panel.legend.layout.hidden,this.parent_panel.legend.render(),this.update()}.bind(this)),this.update())}}),L.Dashboard.Components.add("display_options",function(t){"string"!=typeof t.button_html&&(t.button_html="Display options..."),"string"!=typeof t.button_title&&(t.button_title="Control how plot items are displayed"),L.Dashboard.Component.apply(this,arguments);var r=t.fields_whitelist||["color","filters","fill_opacity","label","legend","point_shape","point_size","tooltip","tooltip_positioning"],l=this.parent_panel.data_layers[t.layer_name];if(!l)throw new Error("Display options could not locate the specified layer_name: '"+t.layer_name+"'");var a=l.layout,h={};r.forEach(function(t){var e=a[t];void 0!==e&&(h[t]=JSON.parse(JSON.stringify(e)))}),this._selected_item="default";var u=this;this.button=new L.Dashboard.Component.Button(u).setColor(t.color).setHtml(t.button_html).setTitle(t.button_title).setOnclick(function(){u.button.menu.populate()}),this.button.menu.setPopulate(function(){var n=Math.floor(1e4*Math.random()).toString();u.button.menu.inner_selector.html("");var o=u.button.menu.inner_selector.append("table"),t=u.layout,a=function(t,e,a){var i=o.append("tr"),s=""+n+a;i.append("td").append("input").attr({id:s,type:"radio",name:"display-option-"+n,value:a}).style("margin",0).property("checked",a===u._selected_item).on("click",function(){r.forEach(function(t){l.layout[t]=e[t]||h[t]}),u._selected_item=a,u.parent_panel.render();var t=u.parent_panel.legend;t&&t.render()}),i.append("td").append("label").style("font-weight","normal").attr("for",s).text(t)},e=t.default_config_display_name||"Default style";return a(e,h,"default"),t.options.forEach(function(t,e){a(t.display_name,t.display,e)}),u}),this.update=function(){return this.button.show(),this}}),L.Dashboard.Components.add("set_state",function(h){var u=this;if("string"!=typeof h.button_html&&(h.button_html="Set option..."),"string"!=typeof h.button_title&&(h.button_title="Choose an option to customize the plot"),L.Dashboard.Component.apply(this,arguments),this.parent_panel)throw new Error("This widget is designed to set global options, so it can only be used at the top (plot) level");if(!h.state_field)throw new Error("Must specify the `state_field` that this widget controls");if(this._selected_item=this.parent_plot.state[h.state_field]||h.options[0].value,!h.options.find(function(t){return t.value===u._selected_item}))throw new Error("There is an existing state value that does not match the known values in this widget");this.button=new L.Dashboard.Component.Button(u).setColor(h.color).setHtml(h.button_html+(h.show_selected?this._selected_item:"")).setTitle(h.button_title).setOnclick(function(){u.button.menu.populate()}),this.button.menu.setPopulate(function(){var r=Math.floor(1e4*Math.random()).toString();u.button.menu.inner_selector.html("");var l=u.button.menu.inner_selector.append("table");return h.options.forEach(function(t,e){var a,i,s,n,o;a=t.display_name,i=t.value,s=e,n=l.append("tr"),o=""+r+s,n.append("td").append("input").attr({id:o,type:"radio",name:"set-state-"+r,value:s}).style("margin",0).property("checked",i===u._selected_item).on("click",function(){var t={};t[h.state_field]=i,u._selected_item=i,u.parent_plot.applyState(t),u.button.setHtml(h.button_html+(h.show_selected?u._selected_item:""))}),n.append("td").append("label").style("font-weight","normal").attr("for",o).text(a)}),u}),this.update=function(){return this.button.show(),this}}),L.Legend=function(t){if(!(t instanceof L.Panel))throw new Error("Unable to create legend, parent must be a locuszoom panel");return this.parent=t,this.id=this.parent.getBaseId()+".legend",this.parent.layout.legend=L.Layouts.merge(this.parent.layout.legend||{},L.Legend.DefaultLayout),this.layout=this.parent.layout.legend,this.selector=null,this.background_rect=null,this.elements=[],this.elements_group=null,this.hidden=!1,this.render()},L.Legend.DefaultLayout={orientation:"vertical",origin:{x:0,y:0},width:10,height:10,padding:5,label_size:12,hidden:!1},L.Legend.prototype.render=function(){this.selector||(this.selector=this.parent.svg.group.append("g").attr("id",this.parent.getBaseId()+".legend").attr("class","lz-legend")),this.background_rect||(this.background_rect=this.selector.append("rect").attr("width",100).attr("height",100).attr("class","lz-legend-background")),this.elements_group||(this.elements_group=this.selector.append("g")),this.elements.forEach(function(t){t.remove()}),this.elements=[];var p=+this.layout.padding||1,y=p,_=p,f=0;this.parent.data_layer_ids_by_z_index.slice().reverse().forEach(function(t){Array.isArray(this.parent.data_layers[t].layout.legend)&&this.parent.data_layers[t].layout.legend.forEach(function(t){var e=this.elements_group.append("g").attr("transform","translate("+y+","+_+")"),a=+t.label_size||+this.layout.label_size||12,i=0,s=a/2+p/2;if(f=Math.max(f,a+p),"line"===t.shape){var n=+t.length||16,o=a/4+p/2;e.append("path").attr("class",t.class||"").attr("d","M0,"+o+"L"+n+","+o).style(t.style||{}),i=n+p}else if("rect"===t.shape){var r=+t.width||16,l=+t.height||r;e.append("rect").attr("class",t.class||"").attr("width",r).attr("height",l).attr("fill",t.color||{}).style(t.style||{}),i=r+p,f=Math.max(f,l+p)}else if(-1!==g.svg.symbolTypes.indexOf(t.shape)){var h=+t.size||40,u=Math.ceil(Math.sqrt(h/Math.PI));e.append("path").attr("class",t.class||"").attr("d",g.svg.symbol().size(h).type(t.shape)).attr("transform","translate("+u+","+(u+p/2)+")").attr("fill",t.color||{}).style(t.style||{}),i=2*u+p,s=Math.max(2*u+p/2,s),f=Math.max(f,2*u+p)}e.append("text").attr("text-anchor","left").attr("class","lz-label").attr("x",i).attr("y",s).style({"font-size":a}).text(t.label);var d=e.node().getBoundingClientRect();if("vertical"===this.layout.orientation)_+=d.height+p,f=0;else{var c=this.layout.origin.x+y+d.width;p<y&&c>this.parent.layout.width&&(_+=f,y=p,e.attr("transform","translate("+y+","+_+")")),y+=d.width+3*p}this.elements.push(e)}.bind(this))}.bind(this));var t=this.elements_group.node().getBoundingClientRect();return this.layout.width=t.width+2*this.layout.padding,this.layout.height=t.height+2*this.layout.padding,this.background_rect.attr("width",this.layout.width).attr("height",this.layout.height),this.selector.style({visibility:this.layout.hidden?"hidden":"visible"}),this.position()},L.Legend.prototype.position=function(){if(!this.selector)return this;var t=this.selector.node().getBoundingClientRect();isNaN(+this.layout.pad_from_bottom)||(this.layout.origin.y=this.parent.layout.height-t.height-+this.layout.pad_from_bottom),isNaN(+this.layout.pad_from_right)||(this.layout.origin.x=this.parent.layout.width-t.width-+this.layout.pad_from_right),this.selector.attr("transform","translate("+this.layout.origin.x+","+this.layout.origin.y+")")},L.Legend.prototype.hide=function(){this.layout.hidden=!0,this.render()},L.Legend.prototype.show=function(){this.layout.hidden=!1,this.render()},L.Data=L.Data||{},L.DataSources=function(){this.sources={}},L.DataSources.prototype.addSource=function(t,e){return console.warn("Warning: .addSource() is deprecated. Use .add() instead"),this.add(t,e)},L.DataSources.prototype.add=function(t,e){return t.match(/[^A-Za-z0-9_]/)&&console.warn("Deprecation warning: source name '"+t+"' should contain only alphanumeric characters or underscores. Use of other characters may break layouts, and will be disallowed in the future."),this.set(t,e)},L.DataSources.prototype.set=function(t,e){if(Array.isArray(e)){var a=L.KnownDataSources.create.apply(null,e);a.source_id=t,this.sources[t]=a}else null!==e?(e.source_id=t,this.sources[t]=e):delete this.sources[t];return this},L.DataSources.prototype.getSource=function(t){return console.warn("Warning: .getSource() is deprecated. Use .get() instead"),this.get(t)},L.DataSources.prototype.get=function(t){return this.sources[t]},L.DataSources.prototype.removeSource=function(t){return console.warn("Warning: .removeSource() is deprecated. Use .remove() instead"),this.remove(t)},L.DataSources.prototype.remove=function(t){return this.set(t,null)},L.DataSources.prototype.fromJSON=function(e){"string"==typeof e&&(e=JSON.parse(e));var a=this;return Object.keys(e).forEach(function(t){a.set(t,e[t])}),a},L.DataSources.prototype.keys=function(){return Object.keys(this.sources)},L.DataSources.prototype.toJSON=function(){return this.sources},L.Data.Field=function(t){var e=/^(?:([^:]+):)?([^:|]*)(\|.+)*$/.exec(t);this.full_name=t,this.namespace=e[1]||null,this.name=e[2]||null,this.transformations=[],"string"==typeof e[3]&&1<e[3].length&&(this.transformations=e[3].substring(1).split("|"),this.transformations.forEach(function(t,e){this.transformations[e]=L.TransformationFunctions.get(t)}.bind(this))),this.applyTransformations=function(e){return this.transformations.forEach(function(t){e=t(e)}),e},this.resolve=function(t,e){if(void 0===t[this.full_name]){var a=null;void 0!==t[this.namespace+":"+this.name]?a=t[this.namespace+":"+this.name]:void 0!==t[this.name]?a=t[this.name]:e&&void 0!==e[this.full_name]&&(a=e[this.full_name]),t[this.full_name]=this.applyTransformations(a)}return t[this.full_name]}},L.Data.Requester=function(l){this.getData=function(e,t){for(var n,o,a=(n={},o=/^(?:([^:]+):)?([^:|]*)(\|.+)*$/,t.forEach(function(t){var e=o.exec(t),a=e[1]||"base",i=e[2],s=L.TransformationFunctions.get(e[3]);void 0===n[a]&&(n[a]={outnames:[],fields:[],trans:[]}),n[a].outnames.push(t),n[a].fields.push(i),n[a].trans.push(s)}),n),i=Object.keys(a).map(function(t){if(!l.get(t))throw new Error("Datasource for namespace "+t+" not found");return l.get(t).getData(e,a[t].fields,a[t].outnames,a[t].trans)}),s=Promise.resolve({header:{},body:[],discrete:{}}),r=0;r<i.length;r++)s=s.then(i[r]);return s}},L.Data.Source=function(){this.enableCache=!0,this.dependentSource=!1},L.Data.Source.prototype.parseInit=function(t){if("string"==typeof t?(this.url=t,this.params={}):(this.url=t.url,this.params=t.params||{}),!this.url)throw new Error("Source not initialized with required URL")},L.Data.Source.prototype.getCacheKey=function(t,e,a){return this.getURL&&this.getURL(t,e,a)},L.Data.Source.prototype.getURL=function(t,e,a){return this.url},L.Data.Source.prototype.fetchRequest=function(t,e,a){var i=this.getURL(t,e,a);return L.createCORSPromise("GET",i)},L.Data.Source.prototype.getRequest=function(t,e,a){var i,s=this.getCacheKey(t,e,a);return this.enableCache&&void 0!==s&&s===this._cachedKey?i=Promise.resolve(this._cachedResponse):(i=this.fetchRequest(t,e,a),this.enableCache&&(this._cachedKey=s,this._cachedResponse=i)),i},L.Data.Source.prototype.getData=function(t,a,i,s){if(this.preGetData){var e=this.preGetData(t,a,i,s);this.pre&&(t=e.state||t,a=e.fields||a,i=e.outnames||i,s=e.trans||s)}var n=this;return function(e){return n.dependentSource&&e&&e.body&&!e.body.length?Promise.resolve(e):n.getRequest(t,e,a).then(function(t){return n.parseResponse(t,e,a,i,s)})}},L.Data.Source.prototype.normalizeResponse=function(e){if(Array.isArray(e))return e;var t=Object.keys(e),a=e[t[0]].length;if(!t.every(function(t){return e[t].length===a}))throw new Error(this.constructor.SOURCE_NAME+" expects a response in which all arrays of data are the same length");for(var i=[],s=Object.keys(e),n=0;n<a;n++){for(var o={},r=0;r<s.length;r++)o[s[r]]=e[s[r]][n];i.push(o)}return i},L.Data.Source.prototype.prepareData=function(t){return console.warn("Warning: .prepareData() is deprecated. Use .annotateData() instead"),this.annotateData(t)},L.Data.Source.prototype.annotateData=function(t,e){return t},L.Data.Source.prototype.extractFields=function(t,s,n,o){if(!Array.isArray(t))return t;if(!t.length)return t;for(var r=[],e=0;e<s.length;e++)r[e]=0;var a=t.map(function(t){for(var e={},a=0;a<s.length;a++){var i=t[s[a]];void 0!==i&&(r[a]=1),o&&o[a]&&(i=o[a](i)),e[n[a]]=i}return e});return r.forEach(function(t,e){if(!t)throw new Error("field "+s[e]+" not found in response for "+n[e])}),a},L.Data.Source.prototype.combineChainBody=function(t,e,a,i,s){return t},L.Data.Source.prototype.parseResponse=function(t,e,a,i,s){var n=this.source_id||this.constructor.SOURCE_NAME;if(e.discrete||(e.discrete={}),!t)return console.error("No usable response was returned for source: '"+n+"'. Parsing will be skipped."),Promise.resolve(e);var o="string"==typeof t?JSON.parse(t):t,r=this;return Promise.resolve(r.normalizeResponse(o.data||o)).then(function(t){return Promise.resolve(r.annotateData(t,e))}).then(function(t){return Promise.resolve(r.extractFields(t,a,i,s))}).then(function(t){return e.discrete[n]=t,Promise.resolve(r.combineChainBody(t,e,a,i,s))}).then(function(t){return{header:e.header||{},discrete:e.discrete,body:t}})},L.Data.Source.prototype.parseArraysToObjects=function(t,e,a,i){console.warn("Warning: .parseArraysToObjects() is no longer used. A stub is provided for legacy use");var s=this.normalizeResponse(t);return this.extractFields(s,e,a,i)},L.Data.Source.prototype.parseObjectsToObjects=function(t,e,a,i){return console.warn("Warning: .parseObjectsToObjects() is deprecated. Use .extractFields() instead"),this.extractFields(t,e,a,i)},L.Data.Source.prototype.parseData=function(t,e,a,i){console.warn("Warning: .parseData() is no longer used. A stub is provided for legacy use");var s=this.normalizeResponse(t);return this.extractFields(s,e,a,i)},L.Data.Source.extend=function(t,e,a){return a?Array.isArray(a)?a=L.KnownDataSources.create.apply(null,a):"string"==typeof a?a=L.KnownDataSources.get(a).prototype:"function"==typeof a&&(a=a.prototype):a=new L.Data.Source,(t=t||function(){}).prototype=a,t.prototype.constructor=t,e&&(t.SOURCE_NAME=e,L.KnownDataSources.add(t)),t},L.Data.Source.prototype.toJSON=function(){return[Object.getPrototypeOf(this).constructor.SOURCE_NAME,{url:this.url,params:this.params}]},L.Data.AssociationSource=L.Data.Source.extend(function(t){this.parseInit(t)},"AssociationLZ"),L.Data.AssociationSource.prototype.preGetData=function(t,e,a,i){return[this.params.id_field||"id","position"].forEach(function(t){-1===e.indexOf(t)&&(e.unshift(t),a.unshift(t),i.unshift(null))}),{fields:e,outnames:a,trans:i}},L.Data.AssociationSource.prototype.getURL=function(t,e,a){var i=e.header.analysis||this.params.source||this.params.analysis;if(void 0===i)throw new Error("Association source must specify an analysis ID to plot");return this.url+"results/?filter=analysis in "+i+" and chromosome in  '"+t.chr+"' and position ge "+t.start+" and position le "+t.end},L.Data.AssociationSource.prototype.normalizeResponse=function(t){return t=L.Data.Source.prototype.normalizeResponse.call(this,t),this.params&&this.params.sort&&t.length&&t[0].position&&t.sort(function(t,e){return t.position-e.position}),t},L.Data.LDSource=L.Data.Source.extend(function(t){this.parseInit(t),this.dependentSource=!0},"LDLZ"),L.Data.LDSource.prototype.preGetData=function(t,e){if(1<e.length&&(2!==e.length||-1===e.indexOf("isrefvar")))throw new Error("LD does not know how to get all fields: "+e.join(", "))},L.Data.LDSource.prototype.findMergeFields=function(t){var s,e={id:this.params.id_field,position:this.params.position_field,pvalue:this.params.pvalue_field,_names_:null};if(t&&t.body&&0<t.body.length){var a=Object.keys(t.body[0]),i=(s=a,function(){for(var t=arguments,e=0;e<t.length;e++){var a=t[e],i=s.filter(function(t){return t.match(a)});if(i.length)return i[0]}return null}),n=e.id&&i(new RegExp(e.id+"\\b"));e.id=n||i(/\bvariant\b/)||i(/\bid\b/),e.position=e.position||i(/\bposition\b/i,/\bpos\b/i),e.pvalue=e.pvalue||i(/\bpvalue\b/i,/\blog_pvalue\b/i),e._names_=a}return e},L.Data.LDSource.prototype.findRequestedFields=function(t,e){for(var a={},i=0;i<t.length;i++)"isrefvar"===t[i]?(a.isrefvarin=t[i],a.isrefvarout=e&&e[i]):(a.ldin=t[i],a.ldout=e&&e[i]);return a},L.Data.LDSource.prototype.normalizeResponse=function(t){return t},L.Data.LDSource.prototype.getRefvar=function(t,e,a){var i=this.findRequestedFields(a).ldin;if("state"===i&&(i=t.ldrefvar||e.header.ldrefvar||"best"),"best"===i){if(!e.body)throw new Error("No association data found to find best pvalue");var s=this.findMergeFields(e);if(!s.pvalue||!s.id){var n="";throw s.id||(n+=(n.length?", ":"")+"id"),s.pvalue||(n+=(n.length?", ":"")+"pvalue"),new Error("Unable to find necessary column(s) for merge: "+n+" (available: "+s._names_+")")}i=e.body[function(t,e){var a;a=/log/.test(e=e||"log_pvalue")?function(t,e){return e<t}:function(t,e){return t<e};for(var i=t[0][e],s=0,n=1;n<t.length;n++)a(t[n][e],i)&&(i=t[n][e],s=n);return s}(e.body,s.pvalue)][s.id]}return i},L.Data.LDSource.prototype.getURL=function(t,e,a){var i=t.ldrefsource||e.header.ldrefsource||1,s=this.getRefvar(t,e,a);return e.header.ldrefvar=s,this.url+"results/?filter=reference eq "+i+" and chromosome2 eq '"+t.chr+"' and position2 ge "+t.start+" and position2 le "+t.end+" and variant1 eq '"+s+"'&fields=chr,pos,rsquare"},L.Data.LDSource.prototype.combineChainBody=function(t,e,a,i,s){var o=this.findMergeFields(e),n=this.findRequestedFields(a,i);if(!o.position)throw new Error("Unable to find position field for merge: "+o._names_);var r=t.rsquare?"rsquare":"correlation";return function(t,e,a,i){for(var s=0,n=0;s<t.length&&n<e.position2.length;)t[s][o.position]===e.position2[n]?(t[s][a]=e[i][n],s++,n++):t[s][o.position]<e.position2[n]?s++:n++}(e.body,t,n.ldout,r),n.isrefvarin&&e.header.ldrefvar&&function(t,e,a,i,s){for(var n=0;n<t.length;n++)t[n][a]&&t[n][a]===e?(t[n][i]=1,t[n][s]=1):t[n][i]=0}(e.body,e.header.ldrefvar,o.id,n.isrefvarout,n.ldout),e.body},L.Data.LDSource2=L.KnownDataSources.extend("LDLZ","LDLZ2",{getURL:function(t,e,a){var i=t.genome_build||this.params.build||"GRCh37",s=t.ld_source||this.params.source||"1000G",n=t.ld_pop||this.params.population||"ALL",o=this.params.method||"rsquare";S(this.constructor.SOURCE_NAME,i,null);var r=this.getRefvar(t,e,a),l=r&&r.match(/^(?:chr)?([a-zA-Z0-9]+?):(\d+)[_:]?(\w+)?[/:|]?([^_]+)?_?(.*)?/);if(!l)throw new Error("Could not request LD for a missing or incomplete marker format");return r=[l[1],":",l[2],"_",l[3],"/",l[4]].join(""),e.header.ldrefvar=r,[this.url,"genome_builds/",i,"/references/",s,"/populations/",n,"/variants","?correlation=",o,"&variant=",encodeURIComponent(r),"&chrom=",encodeURIComponent(t.chr),"&start=",encodeURIComponent(t.start),"&stop=",encodeURIComponent(t.end)].join("")},fetchRequest:function(t,e,a){var i=this.getURL(t,e,a),s={data:{}},n=function(t){return L.createCORSPromise("GET",t).then(function(e){return e=JSON.parse(e),Object.keys(e.data).forEach(function(t){s.data[t]=(s.data[t]||[]).concat(e.data[t])}),e.next?n(e.next):s})};return n(i)}}),L.Data.GwasCatalog=L.Data.Source.extend(function(t){this.parseInit(t),this.dependentSource=!0},"GwasCatalogLZ"),L.Data.GwasCatalog.prototype.getURL=function(t,e,a){var i=t.genome_build||this.params.build;S(this.constructor.SOURCE_NAME,i,null);var s="GRCh38"===i?1:2,n=this.params.source||s;return this.url+"?format=objects&sort=pos&filter=id eq "+n+" and chrom eq '"+t.chr+"' and pos ge "+t.start+" and pos le "+t.end},L.Data.GwasCatalog.prototype.findMergeFields=function(t){var e=Object.keys(t).find(function(t){return t.match(/\b(position|pos)\b/i)});if(!e)throw new Error("Could not find data to align with GWAS catalog results");return{pos:e}},L.Data.GwasCatalog.prototype.extractFields=function(t,e,a,i){return t},L.Data.GwasCatalog.prototype.combineChainBody=function(t,e,a,i,s){if(!t.length)return e.body;var u="log_pvalue",d=i[a.indexOf(u)];function n(t,e,a,i,s){var n=t.n_catalog_matches||0;if(t.n_catalog_matches=n+1,!(u&&t[d]&&t[d]>e[u]))for(var o=0;o<a.length;o++){var r=a[o],l=i[o],h=e[r];s&&s[o]&&(h=s[o](h)),t[l]=h}}for(var o=this.findMergeFields(e.body[0]),r=this.findMergeFields(t[0]),l=0,h=0;l<e.body.length&&h<t.length;){var c=e.body[l],p=t[h];c[o.pos]===p[r.pos]?(n(c,p,a,i,s),h+=1):c[o.pos]<p[r.pos]?l+=1:h+=1}return e.body},L.Data.GeneSource=L.Data.Source.extend(function(t){this.parseInit(t)},"GeneLZ"),L.Data.GeneSource.prototype.getURL=function(t,e,a){var i=t.genome_build||this.params.build,s=this.params.source;return S(this.constructor.SOURCE_NAME,i,s),i&&(s="GRCh38"===i?1:3),this.url+"?filter=source in "+s+" and chrom eq '"+t.chr+"' and start le "+t.end+" and end ge "+t.start},L.Data.GeneSource.prototype.normalizeResponse=function(t){return t},L.Data.GeneSource.prototype.extractFields=function(t,e,a,i){return t},L.Data.GeneConstraintSource=L.Data.Source.extend(function(t){this.parseInit(t)},"GeneConstraintLZ"),L.Data.GeneConstraintSource.prototype.getURL=function(){return this.url},L.Data.GeneConstraintSource.prototype.normalizeResponse=function(t){return t},L.Data.GeneConstraintSource.prototype.getCacheKey=function(t,e,a){var i=t.genome_build||this.params.build,s=[t.chr,t.start,t.end,i].join(" ");return this.url+s},L.Data.GeneConstraintSource.prototype.fetchRequest=function(t,e,a){var i=t.genome_build||this.params.build;if(!i)throw new Error(["Data source",this.constructor.SOURCE_NAME,"requires that you specify a genome_build"].join(" "));var s=e.body.reduce(function(t,e){return t[e.gene_name]=null,t},{}),n=Object.keys(s).map(function(t){return"_"+t.replace(/[^A-Za-z0-9_]/g,"_")+': gene(gene_symbol: "'+t+'", reference_genome: '+i+") { gnomad_constraint { exp_syn obs_syn syn_z oe_syn oe_syn_lower oe_syn_upper exp_mis obs_mis mis_z oe_mis oe_mis_lower oe_mis_upper exp_lof obs_lof pLI oe_lof oe_lof_lower oe_lof_upper } } "});if(!n.length)return Promise.resolve({data:null});n="{"+n.join(" ")+" }";var o=this.getURL(t,e,a),r=JSON.stringify({query:n});return L.createCORSPromise("POST",o,r,{"Content-Type":"application/json"})},L.Data.GeneConstraintSource.prototype.combineChainBody=function(e,t,a,i,s){return e?(t.body.forEach(function(a){var t="_"+a.gene_name.replace(/[^A-Za-z0-9_]/g,"_"),i=e[t]&&e[t].gnomad_constraint;i&&Object.keys(i).forEach(function(t){var e=i[t];void 0===a[t]&&("number"==typeof e&&-1!==e.toString().indexOf(".")&&(e=parseFloat(e.toFixed(2))),a[t]=e)})}),t.body):t},L.Data.RecombinationRateSource=L.Data.Source.extend(function(t){this.parseInit(t)},"RecombLZ"),L.Data.RecombinationRateSource.prototype.getURL=function(t,e,a){var i=t.genome_build||this.params.build,s=this.params.source;return S(this.constructor.SOURCE_NAME,i,s),i&&(s="GRCh38"===i?16:15),this.url+"?filter=id in "+s+" and chromosome eq '"+t.chr+"' and position le "+t.end+" and position ge "+t.start},L.Data.StaticSource=L.Data.Source.extend(function(t){this._data=t},"StaticJSON"),L.Data.StaticSource.prototype.getRequest=function(t,e,a){return Promise.resolve(this._data)},L.Data.StaticSource.prototype.toJSON=function(){return[Object.getPrototypeOf(this).constructor.SOURCE_NAME,this._data]},L.Data.PheWASSource=L.Data.Source.extend(function(t){this.parseInit(t)},"PheWASLZ"),L.Data.PheWASSource.prototype.getURL=function(t,e,a){var i=(t.genome_build?[t.genome_build]:null)||this.params.build;if(!i||!Array.isArray(i)||!i.length)throw new Error(["Data source",this.constructor.SOURCE_NAME,"requires that you specify array of one or more desired genome build names"].join(" "));return[this.url,"?filter=variant eq '",encodeURIComponent(t.variant),"'&format=objects&",i.map(function(t){return"build="+encodeURIComponent(t)}).join("&")].join("")},L.Data.ConnectorSource=L.Data.Source.extend(function(t){if(!t||!t.sources)throw new Error("Connectors must specify the data they require as init.sources = {internal_name: chain_source_id}} pairs");this._source_name_mapping=t.sources;var e=Object.keys(t.sources),a=this;this.REQUIRED_SOURCES.forEach(function(t){if(-1===e.indexOf(t))throw new Error("Configuration for "+a.constructor.SOURCE_NAME+" must specify a source ID corresponding to "+t)}),this.parseInit(t)},"ConnectorSource"),L.Data.ConnectorSource.prototype.REQUIRED_SOURCES=[],L.Data.ConnectorSource.prototype.parseInit=function(t){},L.Data.ConnectorSource.prototype.getRequest=function(t,a,e){var i=this;return Object.keys(this._source_name_mapping).forEach(function(t){var e=i._source_name_mapping[t];if(a.discrete&&!a.discrete[e])throw new Error(i.constructor.SOURCE_NAME+" cannot be used before loading required data for: "+e)}),Promise.resolve(a.body||[])},L.Data.ConnectorSource.prototype.parseResponse=function(t,e,a,i,s){return Promise.resolve(this.combineChainBody(t,e,a,i,s)).then(function(t){return{header:e.header||{},discrete:e.discrete||{},body:t}})},L.Data.ConnectorSource.prototype.combineChainBody=function(t,e){throw new Error("This method must be implemented in a subclass")},L.Plot=function(t,e,a){return this.initialized=!1,(this.parent_plot=this).id=t,this.container=null,this.svg=null,this.panels={},this.panel_ids_by_y_index=[],this.applyPanelYIndexesToPanelLayouts=function(){this.panel_ids_by_y_index.forEach(function(t,e){this.panels[t].layout.y_index=e}.bind(this))},this.getBaseId=function(){return this.id},this.remap_promises=[],this.layout=void 0===a?L.Layouts.merge({},L.Layouts.get("plot","standard_association")):a,L.Layouts.merge(this.layout,L.Plot.DefaultLayout),this._base_layout=JSON.parse(JSON.stringify(this.layout)),this.state=this.layout.state,this.lzd=new L.Data.Requester(e),this.window_onresize=null,this.event_hooks={layout_changed:[],data_requested:[],data_rendered:[],element_clicked:[],element_selection:[],match_requested:[],panel_removed:[],state_changed:[]},this.on=function(t,e){if(!Array.isArray(this.event_hooks[t]))throw new Error("Unable to register event hook, invalid event: "+t.toString());if("function"!=typeof e)throw new Error("Unable to register event hook, invalid hook function passed");return this.event_hooks[t].push(e),e},this.off=function(t,e){var a=this.event_hooks[t];if(!Array.isArray(a))throw new Error("Unable to remove event hook, invalid event: "+t.toString());if(void 0===e)this.event_hooks[t]=[];else{var i=a.indexOf(e);if(-1===i)throw new Error("The specified event listener is not registered and therefore cannot be removed");a.splice(i,1)}return this},this.emit=function(t,a){if(!Array.isArray(this.event_hooks[t]))throw new Error("LocusZoom attempted to throw an invalid event: "+t.toString());var i=this.getBaseId(),s=this;return this.event_hooks[t].forEach(function(t){var e;e=a&&a.sourceID?a:{sourceID:i,data:a||null},t.call(s,e)}),this},this.getPageOrigin=function(){for(var t=this.svg.node().getBoundingClientRect(),e=document.documentElement.scrollLeft||document.body.scrollLeft,a=document.documentElement.scrollTop||document.body.scrollTop,i=this.svg.node();null!==i.parentNode;)if((i=i.parentNode)!==document&&"static"!==g.select(i).style("position")){e=-1*i.getBoundingClientRect().left,a=-1*i.getBoundingClientRect().top;break}return{x:e+t.left,y:a+t.top,width:t.width,height:t.height}},this.getContainerOffset=function(){for(var t={top:0,left:0},e=this.container.offsetParent||null;null!==e;)t.top+=e.offsetTop,t.left+=e.offsetLeft,e=e.offsetParent||null;return t},this.interaction={},this.canInteract=function(t){return(t=t||null)?(void 0===this.interaction.panel_id||this.interaction.panel_id===t)&&!this.loading_data:!(this.interaction.dragging||this.interaction.zooming||this.loading_data)},this.initializeLayout(),this},L.Plot.DefaultLayout={state:{},width:1,height:1,min_width:1,min_height:1,responsive_resize:!1,aspect_ratio:1,panels:[],dashboard:{components:[]},panel_boundaries:!0,mouse_guide:!0},L.Plot.prototype.sumProportional=function(t){if("height"!==t&&"width"!==t)throw new Error("Bad dimension value passed to LocusZoom.Plot.prototype.sumProportional");var e=0;for(var a in this.panels)this.panels[a].layout["proportional_"+t]||(this.panels[a].layout["proportional_"+t]=1/Object.keys(this.panels).length),e+=this.panels[a].layout["proportional_"+t];return e},L.Plot.prototype.rescaleSVG=function(){var t=this.svg.node().getBoundingClientRect();return this.setDimensions(t.width,t.height),this},L.Plot.prototype.initializeLayout=function(){if(isNaN(this.layout.width)||this.layout.width<=0)throw new Error("Plot layout parameter `width` must be a positive number");if(isNaN(this.layout.height)||this.layout.height<=0)throw new Error("Plot layout parameter `width` must be a positive number");if(isNaN(this.layout.aspect_ratio)||this.layout.aspect_ratio<=0)throw new Error("Plot layout parameter `aspect_ratio` must be a positive number");!0===this.layout.responsive_resize&&(console.warn('LocusZoom "responsive_resize" specifies a deprecated value. The new value should be "both". Please update your layout.'),this.layout.responsive_resize="both");var t=[!1,"both","width_only"];if(-1===t.indexOf(this.layout.responsive_resize))throw new Error('LocusZoom option "responsive_resize" should specify one of the following modes: '+t.join(", "));return this.layout.responsive_resize&&(this.window_onresize=g.select(window).on("resize.lz-"+this.id,function(){this.rescaleSVG()}.bind(this)),g.select(window).on("load.lz-"+this.id,function(){this.setDimensions()}.bind(this))),this.layout.panels.forEach(function(t){this.addPanel(t)}.bind(this)),this},L.Plot.prototype.setDimensions=function(t,e){var a,i=parseFloat(this.layout.min_width)||0,s=parseFloat(this.layout.min_height)||0;for(a in this.panels)i=Math.max(i,this.panels[a].layout.min_width),0<parseFloat(this.panels[a].layout.min_height)&&0<parseFloat(this.panels[a].layout.proportional_height)&&(s=Math.max(s,this.panels[a].layout.min_height/this.panels[a].layout.proportional_height));if(this.layout.min_width=Math.max(i,1),this.layout.min_height=Math.max(s,1),g.select(this.svg.node().parentNode).style({"min-width":this.layout.min_width+"px","min-height":this.layout.min_height+"px"}),!isNaN(t)&&0<=t&&!isNaN(e)&&0<=e){this.layout.width=Math.max(Math.round(+t),this.layout.min_width),this.layout.height=Math.max(Math.round(+e),this.layout.min_height),this.layout.aspect_ratio=this.layout.width/this.layout.height,this.layout.responsive_resize&&(this.svg&&(this.layout.width=Math.max(this.svg.node().parentNode.getBoundingClientRect().width,this.layout.min_width)),"both"===this.layout.responsive_resize&&(this.layout.height=this.layout.width/this.layout.aspect_ratio,this.layout.height<this.layout.min_height&&(this.layout.height=this.layout.min_height,this.layout.width=this.layout.height*this.layout.aspect_ratio)));var n=0;this.panel_ids_by_y_index.forEach(function(t){var e=this.layout.width,a=this.panels[t].layout.proportional_height*this.layout.height;this.panels[t].setDimensions(e,a),this.panels[t].setOrigin(0,n),this.panels[t].layout.proportional_origin.x=0,this.panels[t].layout.proportional_origin.y=n/this.layout.height,n+=a,this.panels[t].dashboard.update()}.bind(this))}else if(Object.keys(this.panels).length){for(a in this.layout.width=0,this.layout.height=0,this.panels)this.layout.width=Math.max(this.panels[a].layout.width,this.layout.width),this.layout.height+=this.panels[a].layout.height;this.layout.width=Math.max(this.layout.width,this.layout.min_width),this.layout.height=Math.max(this.layout.height,this.layout.min_height)}return this.layout.aspect_ratio=this.layout.width/this.layout.height,null!==this.svg&&("both"===this.layout.responsive_resize?this.svg.attr("viewBox","0 0 "+this.layout.width+" "+this.layout.height).attr("preserveAspectRatio","xMinYMin meet"):this.svg.attr("width",this.layout.width).attr("height",this.layout.height)),this.initialized&&(this.panel_boundaries.position(),this.dashboard.update(),this.curtain.update(),this.loader.update()),this.emit("layout_changed")},L.Plot.prototype.addPanel=function(t){if("object"!=typeof t)throw new Error("Invalid panel layout passed to LocusZoom.Plot.prototype.addPanel()");var a=new L.Panel(t,this);if(null!==(this.panels[a.id]=a).layout.y_index&&!isNaN(a.layout.y_index)&&0<this.panel_ids_by_y_index.length)a.layout.y_index<0&&(a.layout.y_index=Math.max(this.panel_ids_by_y_index.length+a.layout.y_index,0)),this.panel_ids_by_y_index.splice(a.layout.y_index,0,a.id),this.applyPanelYIndexesToPanelLayouts();else{var e=this.panel_ids_by_y_index.push(a.id);this.panels[a.id].layout.y_index=e-1}var i=null;return this.layout.panels.forEach(function(t,e){t.id===a.id&&(i=e)}),null===i&&(i=this.layout.panels.push(this.panels[a.id].layout)-1),this.panels[a.id].layout_idx=i,this.initialized&&(this.positionPanels(),this.panels[a.id].initialize(),this.panels[a.id].reMap(),this.setDimensions(this.layout.width,this.layout.height)),this.panels[a.id]},L.Plot.prototype.clearPanelData=function(t,i){var e;i=i||"wipe",e=t?[t]:Object.keys(this.panels);var s=this;return e.forEach(function(a){s.panels[a].data_layer_ids_by_z_index.forEach(function(t){var e=s.panels[a].data_layers[t];e.destroyAllTooltips(),delete e.layer_state,delete s.layout.state[e.state_id],"reset"===i&&e._setDefaultState()})}),this},L.Plot.prototype.removePanel=function(t){if(!this.panels[t])throw new Error("Unable to remove panel, ID not found: "+t);return this.panel_boundaries.hide(),this.clearPanelData(t),this.panels[t].loader.hide(),this.panels[t].dashboard.destroy(!0),this.panels[t].curtain.hide(),this.panels[t].svg.container&&this.panels[t].svg.container.remove(),this.layout.panels.splice(this.panels[t].layout_idx,1),delete this.panels[t],delete this.layout.state[t],this.layout.panels.forEach(function(t,e){this.panels[t.id].layout_idx=e}.bind(this)),this.panel_ids_by_y_index.splice(this.panel_ids_by_y_index.indexOf(t),1),this.applyPanelYIndexesToPanelLayouts(),this.initialized&&(this.layout.min_height=this._base_layout.min_height,this.layout.min_width=this._base_layout.min_width,this.positionPanels(),this.setDimensions(this.layout.width,this.layout.height)),this.emit("panel_removed",t),this},L.Plot.prototype.positionPanels=function(){var t,a={left:0,right:0};for(t in this.panels)null===this.panels[t].layout.proportional_height&&(this.panels[t].layout.proportional_height=this.panels[t].layout.height/this.layout.height),null===this.panels[t].layout.proportional_width&&(this.panels[t].layout.proportional_width=1),this.panels[t].layout.interaction.x_linked&&(a.left=Math.max(a.left,this.panels[t].layout.margin.left),a.right=Math.max(a.right,this.panels[t].layout.margin.right));var e=this.sumProportional("height");if(!e)return this;var i=1/e;for(t in this.panels)this.panels[t].layout.proportional_height*=i;var s=0;this.panel_ids_by_y_index.forEach(function(t){if(this.panels[t].setOrigin(0,s),this.panels[t].layout.proportional_origin.x=0,s+=this.panels[t].layout.height,this.panels[t].layout.interaction.x_linked){var e=Math.max(a.left-this.panels[t].layout.margin.left,0)+Math.max(a.right-this.panels[t].layout.margin.right,0);this.panels[t].layout.width+=e,this.panels[t].layout.margin.left=a.left,this.panels[t].layout.margin.right=a.right,this.panels[t].layout.cliparea.origin.x=a.left}}.bind(this));var n=s;return this.panel_ids_by_y_index.forEach(function(t){this.panels[t].layout.proportional_origin.y=this.panels[t].layout.origin.y/n}.bind(this)),this.setDimensions(),this.panel_ids_by_y_index.forEach(function(t){this.panels[t].setDimensions(this.layout.width*this.panels[t].layout.proportional_width,this.layout.height*this.panels[t].layout.proportional_height)}.bind(this)),this},L.Plot.prototype.initialize=function(){if(this.layout.responsive_resize&&g.select(this.container).classed("lz-container-responsive",!0),this.layout.mouse_guide){var t=this.svg.append("g").attr("class","lz-mouse_guide").attr("id",this.id+".mouse_guide"),e=t.append("rect").attr("class","lz-mouse_guide-vertical").attr("x",-1),a=t.append("rect").attr("class","lz-mouse_guide-horizontal").attr("y",-1);this.mouse_guide={svg:t,vertical:e,horizontal:a}}for(var i in this.curtain=L.generateCurtain.call(this),this.loader=L.generateLoader.call(this),this.panel_boundaries={parent:this,hide_timeout:null,showing:!1,dragging:!1,selectors:[],corner_selector:null,show:function(){if(!this.showing&&!this.parent.curtain.showing){this.showing=!0,this.parent.panel_ids_by_y_index.forEach(function(t,n){var e=g.select(this.parent.svg.node().parentNode).insert("div",".lz-data_layer-tooltip").attr("class","lz-panel-boundary").attr("title","Resize panel");e.append("span");var a=g.behavior.drag();a.on("dragstart",function(){this.dragging=!0}.bind(this)),a.on("dragend",function(){this.dragging=!1}.bind(this)),a.on("drag",function(){var t=this.parent.panels[this.parent.panel_ids_by_y_index[n]],e=t.layout.height;t.setDimensions(t.layout.width,t.layout.height+g.event.dy);var i=t.layout.height-e,s=this.parent.layout.height+i;this.parent.panel_ids_by_y_index.forEach(function(t,e){var a=this.parent.panels[this.parent.panel_ids_by_y_index[e]];a.layout.proportional_height=a.layout.height/s,n<e&&(a.setOrigin(a.layout.origin.x,a.layout.origin.y+i),a.dashboard.position())}.bind(this)),this.parent.positionPanels(),this.position()}.bind(this)),e.call(a),this.parent.panel_boundaries.selectors.push(e)}.bind(this));var t=g.select(this.parent.svg.node().parentNode).insert("div",".lz-data_layer-tooltip").attr("class","lz-panel-corner-boundary").attr("title","Resize plot");t.append("span").attr("class","lz-panel-corner-boundary-outer"),t.append("span").attr("class","lz-panel-corner-boundary-inner");var e=g.behavior.drag();e.on("dragstart",function(){this.dragging=!0}.bind(this)),e.on("dragend",function(){this.dragging=!1}.bind(this)),e.on("drag",function(){this.setDimensions(this.layout.width+g.event.dx,this.layout.height+g.event.dy)}.bind(this.parent)),t.call(e),this.parent.panel_boundaries.corner_selector=t}return this.position()},position:function(){if(!this.showing)return this;var o=this.parent.getPageOrigin();this.selectors.forEach(function(t,e){var a=this.parent.panels[this.parent.panel_ids_by_y_index[e]].getPageOrigin(),i=o.x,s=a.y+this.parent.panels[this.parent.panel_ids_by_y_index[e]].layout.height-12,n=this.parent.layout.width-1;t.style({top:s+"px",left:i+"px",width:n+"px"}),t.select("span").style({width:n+"px"})}.bind(this));return this.corner_selector.style({top:o.y+this.parent.layout.height-10-16+"px",left:o.x+this.parent.layout.width-10-16+"px"}),this},hide:function(){return this.showing&&(this.showing=!1,this.selectors.forEach(function(t){t.remove()}),this.selectors=[],this.corner_selector.remove(),this.corner_selector=null),this}},this.layout.panel_boundaries&&(g.select(this.svg.node().parentNode).on("mouseover."+this.id+".panel_boundaries",function(){clearTimeout(this.panel_boundaries.hide_timeout),this.panel_boundaries.show()}.bind(this)),g.select(this.svg.node().parentNode).on("mouseout."+this.id+".panel_boundaries",function(){this.panel_boundaries.hide_timeout=setTimeout(function(){this.panel_boundaries.hide()}.bind(this),300)}.bind(this))),this.dashboard=new L.Dashboard(this).show(),this.panels)this.panels[i].initialize();var s="."+this.id;if(this.layout.mouse_guide){var n=function(){this.mouse_guide.vertical.attr("x",-1),this.mouse_guide.horizontal.attr("y",-1)}.bind(this),o=function(){var t=g.mouse(this.svg.node());this.mouse_guide.vertical.attr("x",t[0]),this.mouse_guide.horizontal.attr("y",t[1])}.bind(this);this.svg.on("mouseout"+s+"-mouse_guide",n).on("touchleave"+s+"-mouse_guide",n).on("mousemove"+s+"-mouse_guide",o)}var r=function(){this.stopDrag()}.bind(this),l=function(){if(this.interaction.dragging){var t=g.mouse(this.svg.node());g.event&&g.event.preventDefault(),this.interaction.dragging.dragged_x=t[0]-this.interaction.dragging.start_x,this.interaction.dragging.dragged_y=t[1]-this.interaction.dragging.start_y,this.panels[this.interaction.panel_id].render(),this.interaction.linked_panel_ids.forEach(function(t){this.panels[t].render()}.bind(this))}}.bind(this);this.svg.on("mouseup"+s,r).on("touchend"+s,r).on("mousemove"+s,l).on("touchmove"+s,l),g.select("body").empty()||g.select("body").on("mouseup"+s,r).on("touchend"+s,r),this.on("match_requested",function(t){var e=t.data,a=e.active?e.value:null;this.applyState({lz_match_value:a})}.bind(this)),this.initialized=!0;var h=this.svg.node().getBoundingClientRect(),u=h.width?h.width:this.layout.width,d=h.height?h.height:this.layout.height;return this.setDimensions(u,d),this},L.Plot.prototype.refresh=function(){return this.applyState()},L.Plot.prototype.subscribeToData=function(t,e,a){var i=(a=a||{}).onerror||function(t){console.log("An error occurred while acting on an external callback",t)},s=this,n=function(){try{s.lzd.getData(s.state,t).then(function(t){e(a.discrete?t.discrete:t.body)}).catch(i)}catch(t){i(t)}};return this.on("data_rendered",n),n},L.Plot.prototype.applyState=function(t){if("object"!=typeof(t=t||{}))throw new Error("LocusZoom.applyState only accepts an object; "+typeof t+" given");var e={chr:this.state.chr,start:this.state.start,end:this.state.end};for(var a in t)e[a]=t[a];for(a in e=L._updateStatePosition(e,this.layout))this.state[a]=e[a];for(var i in this.emit("data_requested"),this.remap_promises=[],this.loading_data=!0,this.panels)this.remap_promises.push(this.panels[i].reMap());return Promise.all(this.remap_promises).catch(function(t){console.error(t),this.curtain.show(t.message||t),this.loading_data=!1}.bind(this)).then(function(){this.dashboard.update(),this.panel_ids_by_y_index.forEach(function(t){var e=this.panels[t];e.dashboard.update(),e.data_layer_ids_by_z_index.forEach(function(t){this.data_layers[t].applyAllElementStatus()}.bind(e))}.bind(this)),this.emit("layout_changed"),this.emit("data_rendered"),this.emit("state_changed",t),this.loading_data=!1}.bind(this))},L.Plot.prototype.startDrag=function(t,e){t=t||null;var a=null;switch(e=e||null){case"background":case"x_tick":a="x";break;case"y1_tick":a="y1";break;case"y2_tick":a="y2"}if(!(t instanceof L.Panel&&a&&this.canInteract()))return this.stopDrag();var i=g.mouse(this.svg.node());return this.interaction={panel_id:t.id,linked_panel_ids:t.getLinkedPanelIds(a),dragging:{method:e,start_x:i[0],start_y:i[1],dragged_x:0,dragged_y:0,axis:a}},this.svg.style("cursor","all-scroll"),this},L.Plot.prototype.stopDrag=function(){if(!this.interaction.dragging)return this;if("object"!=typeof this.panels[this.interaction.panel_id])return this.interaction={},this;var s=this.panels[this.interaction.panel_id],t=function(e,a,i){s.data_layer_ids_by_z_index.forEach(function(t){s.data_layers[t].layout[e+"_axis"].axis===a&&(s.data_layers[t].layout[e+"_axis"].floor=i[0],s.data_layers[t].layout[e+"_axis"].ceiling=i[1],delete s.data_layers[t].layout[e+"_axis"].lower_buffer,delete s.data_layers[t].layout[e+"_axis"].upper_buffer,delete s.data_layers[t].layout[e+"_axis"].min_extent,delete s.data_layers[t].layout[e+"_axis"].ticks)})};switch(this.interaction.dragging.method){case"background":case"x_tick":0!==this.interaction.dragging.dragged_x&&(t("x",1,s.x_extent),this.applyState({start:s.x_extent[0],end:s.x_extent[1]}));break;case"y1_tick":case"y2_tick":if(0!==this.interaction.dragging.dragged_y){var e=parseInt(this.interaction.dragging.method[1]);t("y",e,s["y"+e+"_extent"])}}return this.interaction={},this.svg.style("cursor",null),this},L.Panel=function(t,e){if("object"!=typeof t)throw new Error("Unable to create panel, invalid layout");if(this.parent=e||null,this.parent_plot=e,"string"==typeof t.id&&t.id.length){if(this.parent&&void 0!==this.parent.panels[t.id])throw new Error("Cannot create panel with id ["+t.id+"]; panel with that id already exists")}else if(this.parent){var a=null,i=function(){null!=(a="p"+Math.floor(Math.random()*Math.pow(10,8)))&&void 0===this.parent.panels[a]||(a=i())}.bind(this);t.id=a}else t.id="p"+Math.floor(Math.random()*Math.pow(10,8));return this.id=t.id,this.initialized=!1,this.layout_idx=null,this.svg={},this.layout=L.Layouts.merge(t||{},L.Panel.DefaultLayout),this.parent?(this.state=this.parent.state,this.state_id=this.id,this.state[this.state_id]=this.state[this.state_id]||{}):(this.state=null,this.state_id=null),this.data_layers={},this.data_layer_ids_by_z_index=[],this.applyDataLayerZIndexesToDataLayerLayouts=function(){this.data_layer_ids_by_z_index.forEach(function(t,e){this.data_layers[t].layout.z_index=e}.bind(this))}.bind(this),this.data_promises=[],this.x_scale=null,this.y1_scale=null,this.y2_scale=null,this.x_extent=null,this.y1_extent=null,this.y2_extent=null,this.x_ticks=[],this.y1_ticks=[],this.y2_ticks=[],this.zoom_timeout=null,this.getBaseId=function(){return this.parent.id+"."+this.id},this.event_hooks={layout_changed:[],data_requested:[],data_rendered:[],element_clicked:[],element_selection:[],match_requested:[]},this.on=function(t,e){if(!Array.isArray(this.event_hooks[t]))throw new Error("Unable to register event hook, invalid event: "+t.toString());if("function"!=typeof e)throw new Error("Unable to register event hook, invalid hook function passed");return this.event_hooks[t].push(e),e},this.off=function(t,e){var a=this.event_hooks[t];if(!Array.isArray(a))throw new Error("Unable to remove event hook, invalid event: "+t.toString());if(void 0===e)this.event_hooks[t]=[];else{var i=a.indexOf(e);if(-1===i)throw new Error("The specified event listener is not registered and therefore cannot be removed");a.splice(i,1)}return this},this.emit=function(t,e,a){if(a=a||!1,!Array.isArray(this.event_hooks[t]))throw new Error("LocusZoom attempted to throw an invalid event: "+t.toString());"boolean"==typeof e&&2===arguments.length&&(a=e,e=null);var i=this.getBaseId(),s=this,n={sourceID:i,data:e||null};return this.event_hooks[t].forEach(function(t){t.call(s,n)}),a&&this.parent&&this.parent.emit(t,n),this},this.getPageOrigin=function(){var t=this.parent.getPageOrigin();return{x:t.x+this.layout.origin.x,y:t.y+this.layout.origin.y}},this.initializeLayout(),this},L.Panel.DefaultLayout={title:{text:"",style:{},x:10,y:22},y_index:null,width:0,height:0,origin:{x:0,y:null},min_width:1,min_height:1,proportional_width:null,proportional_height:null,proportional_origin:{x:0,y:null},margin:{top:0,right:0,bottom:0,left:0},background_click:"clear_selections",dashboard:{components:[]},cliparea:{height:0,width:0,origin:{x:0,y:0}},axes:{x:{},y1:{},y2:{}},legend:null,interaction:{drag_background_to_pan:!1,drag_x_ticks_to_scale:!1,drag_y1_ticks_to_scale:!1,drag_y2_ticks_to_scale:!1,scroll_to_zoom:!1,x_linked:!1,y1_linked:!1,y2_linked:!1},data_layers:[]},L.Panel.prototype.initializeLayout=function(){if(0===this.layout.width&&null===this.layout.proportional_width&&(this.layout.proportional_width=1),0===this.layout.height&&null===this.layout.proportional_height){var t=Object.keys(this.parent.panels).length;this.layout.proportional_height=0<t?1/t:1}return this.setDimensions(),this.setOrigin(),this.setMargin(),this.x_range=[0,this.layout.cliparea.width],this.y1_range=[this.layout.cliparea.height,0],this.y2_range=[this.layout.cliparea.height,0],["x","y1","y2"].forEach(function(t){Object.keys(this.layout.axes[t]).length&&!1!==this.layout.axes[t].render?(this.layout.axes[t].render=!0,this.layout.axes[t].label=this.layout.axes[t].label||null,this.layout.axes[t].label_function=this.layout.axes[t].label_function||null):this.layout.axes[t].render=!1}.bind(this)),this.layout.data_layers.forEach(function(t){this.addDataLayer(t)}.bind(this)),this},L.Panel.prototype.setDimensions=function(t,e){return void 0!==t&&void 0!==e?!isNaN(t)&&0<=t&&!isNaN(e)&&0<=e&&(this.layout.width=Math.max(Math.round(+t),this.layout.min_width),this.layout.height=Math.max(Math.round(+e),this.layout.min_height)):(null!==this.layout.proportional_width&&(this.layout.width=Math.max(this.layout.proportional_width*this.parent.layout.width,this.layout.min_width)),null!==this.layout.proportional_height&&(this.layout.height=Math.max(this.layout.proportional_height*this.parent.layout.height,this.layout.min_height))),this.layout.cliparea.width=Math.max(this.layout.width-(this.layout.margin.left+this.layout.margin.right),0),this.layout.cliparea.height=Math.max(this.layout.height-(this.layout.margin.top+this.layout.margin.bottom),0),this.svg.clipRect&&this.svg.clipRect.attr("width",this.layout.width).attr("height",this.layout.height),this.initialized&&(this.render(),this.curtain.update(),this.loader.update(),this.dashboard.update(),this.legend&&this.legend.position()),this},L.Panel.prototype.setOrigin=function(t,e){return!isNaN(t)&&0<=t&&(this.layout.origin.x=Math.max(Math.round(+t),0)),!isNaN(e)&&0<=e&&(this.layout.origin.y=Math.max(Math.round(+e),0)),this.initialized&&this.render(),this},L.Panel.prototype.setMargin=function(t,e,a,i){var s;return!isNaN(t)&&0<=t&&(this.layout.margin.top=Math.max(Math.round(+t),0)),!isNaN(e)&&0<=e&&(this.layout.margin.right=Math.max(Math.round(+e),0)),!isNaN(a)&&0<=a&&(this.layout.margin.bottom=Math.max(Math.round(+a),0)),!isNaN(i)&&0<=i&&(this.layout.margin.left=Math.max(Math.round(+i),0)),this.layout.margin.top+this.layout.margin.bottom>this.layout.height&&(s=Math.floor((this.layout.margin.top+this.layout.margin.bottom-this.layout.height)/2),this.layout.margin.top-=s,this.layout.margin.bottom-=s),this.layout.margin.left+this.layout.margin.right>this.layout.width&&(s=Math.floor((this.layout.margin.left+this.layout.margin.right-this.layout.width)/2),this.layout.margin.left-=s,this.layout.margin.right-=s),["top","right","bottom","left"].forEach(function(t){this.layout.margin[t]=Math.max(this.layout.margin[t],0)}.bind(this)),this.layout.cliparea.width=Math.max(this.layout.width-(this.layout.margin.left+this.layout.margin.right),0),this.layout.cliparea.height=Math.max(this.layout.height-(this.layout.margin.top+this.layout.margin.bottom),0),this.layout.cliparea.origin.x=this.layout.margin.left,this.layout.cliparea.origin.y=this.layout.margin.top,this.initialized&&this.render(),this},L.Panel.prototype.setTitle=function(t){if("string"==typeof this.layout.title){var e=this.layout.title;this.layout.title={text:e,x:0,y:0,style:{}}}return"string"==typeof t?this.layout.title.text=t:"object"==typeof t&&null!==t&&(this.layout.title=L.Layouts.merge(t,this.layout.title)),this.layout.title.text.length?this.title.attr("display",null).attr("x",parseFloat(this.layout.title.x)).attr("y",parseFloat(this.layout.title.y)).style(this.layout.title.style).text(this.layout.title.text):this.title.attr("display","none"),this},L.Panel.prototype.initialize=function(){this.svg.container=this.parent.svg.append("g").attr("id",this.getBaseId()+".panel_container").attr("transform","translate("+(this.layout.origin.x||0)+","+(this.layout.origin.y||0)+")");var t=this.svg.container.append("clipPath").attr("id",this.getBaseId()+".clip");if(this.svg.clipRect=t.append("rect").attr("width",this.layout.width).attr("height",this.layout.height),this.svg.group=this.svg.container.append("g").attr("id",this.getBaseId()+".panel").attr("clip-path","url(#"+this.getBaseId()+".clip)"),this.curtain=L.generateCurtain.call(this),this.loader=L.generateLoader.call(this),this.dashboard=new L.Dashboard(this),this.inner_border=this.svg.group.append("rect").attr("class","lz-panel-background").on("click",function(){"clear_selections"===this.layout.background_click&&this.clearSelections()}.bind(this)),this.title=this.svg.group.append("text").attr("class","lz-panel-title"),void 0!==this.layout.title&&this.setTitle(),this.svg.x_axis=this.svg.group.append("g").attr("id",this.getBaseId()+".x_axis").attr("class","lz-x lz-axis"),this.layout.axes.x.render&&(this.svg.x_axis_label=this.svg.x_axis.append("text").attr("class","lz-x lz-axis lz-label").attr("text-anchor","middle")),this.svg.y1_axis=this.svg.group.append("g").attr("id",this.getBaseId()+".y1_axis").attr("class","lz-y lz-y1 lz-axis"),this.layout.axes.y1.render&&(this.svg.y1_axis_label=this.svg.y1_axis.append("text").attr("class","lz-y1 lz-axis lz-label").attr("text-anchor","middle")),this.svg.y2_axis=this.svg.group.append("g").attr("id",this.getBaseId()+".y2_axis").attr("class","lz-y lz-y2 lz-axis"),this.layout.axes.y2.render&&(this.svg.y2_axis_label=this.svg.y2_axis.append("text").attr("class","lz-y2 lz-axis lz-label").attr("text-anchor","middle")),this.data_layer_ids_by_z_index.forEach(function(t){this.data_layers[t].initialize()}.bind(this)),this.legend=null,this.layout.legend&&(this.legend=new L.Legend(this)),this.layout.interaction.drag_background_to_pan){var e="."+this.parent.id+"."+this.id+".interaction.drag",a=function(){this.parent.startDrag(this,"background")}.bind(this);this.svg.container.select(".lz-panel-background").on("mousedown"+e+".background",a).on("touchstart"+e+".background",a)}return this},L.Panel.prototype.resortDataLayers=function(){var e=[];this.data_layer_ids_by_z_index.forEach(function(t){e.push(this.data_layers[t].layout.z_index)}.bind(this)),this.svg.group.selectAll("g.lz-data_layer-container").data(e).sort(g.ascending),this.applyDataLayerZIndexesToDataLayerLayouts()},L.Panel.prototype.getLinkedPanelIds=function(e){var a=[];return-1===["x","y1","y2"].indexOf(e=e||null)||this.layout.interaction[e+"_linked"]&&this.parent.panel_ids_by_y_index.forEach(function(t){t!==this.id&&this.parent.panels[t].layout.interaction[e+"_linked"]&&a.push(t)}.bind(this)),a},L.Panel.prototype.moveUp=function(){return this.parent.panel_ids_by_y_index[this.layout.y_index-1]&&(this.parent.panel_ids_by_y_index[this.layout.y_index]=this.parent.panel_ids_by_y_index[this.layout.y_index-1],this.parent.panel_ids_by_y_index[this.layout.y_index-1]=this.id,this.parent.applyPanelYIndexesToPanelLayouts(),this.parent.positionPanels()),this},L.Panel.prototype.moveDown=function(){return this.parent.panel_ids_by_y_index[this.layout.y_index+1]&&(this.parent.panel_ids_by_y_index[this.layout.y_index]=this.parent.panel_ids_by_y_index[this.layout.y_index+1],this.parent.panel_ids_by_y_index[this.layout.y_index+1]=this.id,this.parent.applyPanelYIndexesToPanelLayouts(),this.parent.positionPanels()),this},L.Panel.prototype.addDataLayer=function(t){if("object"!=typeof t||"string"!=typeof t.id||!t.id.length)throw new Error("Invalid data layer layout passed to LocusZoom.Panel.prototype.addDataLayer()");if(void 0!==this.data_layers[t.id])throw new Error("Cannot create data_layer with id ["+t.id+"]; data layer with that id already exists in the panel");if("string"!=typeof t.type)throw new Error("Invalid data layer type in layout passed to LocusZoom.Panel.prototype.addDataLayer()");"object"!=typeof t.y_axis||void 0!==t.y_axis.axis&&-1!==[1,2].indexOf(t.y_axis.axis)||(t.y_axis.axis=1);var a=L.DataLayers.get(t.type,t,this);if(null!==(this.data_layers[a.id]=a).layout.z_index&&!isNaN(a.layout.z_index)&&0<this.data_layer_ids_by_z_index.length)a.layout.z_index<0&&(a.layout.z_index=Math.max(this.data_layer_ids_by_z_index.length+a.layout.z_index,0)),this.data_layer_ids_by_z_index.splice(a.layout.z_index,0,a.id),this.data_layer_ids_by_z_index.forEach(function(t,e){this.data_layers[t].layout.z_index=e}.bind(this));else{var e=this.data_layer_ids_by_z_index.push(a.id);this.data_layers[a.id].layout.z_index=e-1}var i=null;return this.layout.data_layers.forEach(function(t,e){t.id===a.id&&(i=e)}),null===i&&(i=this.layout.data_layers.push(this.data_layers[a.id].layout)-1),this.data_layers[a.id].layout_idx=i,this.data_layers[a.id]},L.Panel.prototype.removeDataLayer=function(t){if(!this.data_layers[t])throw new Error("Unable to remove data layer, ID not found: "+t);return this.data_layers[t].destroyAllTooltips(),this.data_layers[t].svg.container&&this.data_layers[t].svg.container.remove(),this.layout.data_layers.splice(this.data_layers[t].layout_idx,1),delete this.state[this.data_layers[t].state_id],delete this.data_layers[t],this.data_layer_ids_by_z_index.splice(this.data_layer_ids_by_z_index.indexOf(t),1),this.applyDataLayerZIndexesToDataLayerLayouts(),this.layout.data_layers.forEach(function(t,e){this.data_layers[t.id].layout_idx=e}.bind(this)),this},L.Panel.prototype.clearSelections=function(){return this.data_layer_ids_by_z_index.forEach(function(t){this.data_layers[t].setAllElementStatus("selected",!1)}.bind(this)),this},L.Panel.prototype.reMap=function(){for(var t in this.emit("data_requested"),this.data_promises=[],this.curtain.hide(),this.data_layers)try{this.data_promises.push(this.data_layers[t].reMap())}catch(t){console.error(t),this.curtain.show(t.message||t)}return Promise.all(this.data_promises).then(function(){this.initialized=!0,this.render(),this.emit("layout_changed",!0),this.emit("data_rendered")}.bind(this)).catch(function(t){console.error(t),this.curtain.show(t.message||t)}.bind(this))},L.Panel.prototype.generateExtents=function(){for(var t in["x","y1","y2"].forEach(function(t){this[t+"_extent"]=null}.bind(this)),this.data_layers){var e=this.data_layers[t];if(e.layout.x_axis&&!e.layout.x_axis.decoupled&&(this.x_extent=g.extent((this.x_extent||[]).concat(e.getAxisExtent("x")))),e.layout.y_axis&&!e.layout.y_axis.decoupled){var a="y"+e.layout.y_axis.axis;this[a+"_extent"]=g.extent((this[a+"_extent"]||[]).concat(e.getAxisExtent("y")))}}return this.layout.axes.x&&"state"===this.layout.axes.x.extent&&(this.x_extent=[this.state.start,this.state.end]),this},L.Panel.prototype.generateTicks=function(i){if(this.layout.axes[i].ticks){var a=this.layout.axes[i].ticks;if(Array.isArray(a))return a;if("object"==typeof a){var s=this,n={position:a.position};return this.data_layer_ids_by_z_index.reduce(function(t,e){var a=s.data_layers[e];return t.concat(a.getTicks(i,n))},[]).map(function(t){var e={};return e=L.Layouts.merge(e,a),L.Layouts.merge(e,t)})}}return this[i+"_extent"]?L.prettyTicks(this[i+"_extent"],"both"):[]},L.Panel.prototype.render=function(){this.svg.container.attr("transform","translate("+this.layout.origin.x+","+this.layout.origin.y+")"),this.svg.clipRect.attr("width",this.layout.width).attr("height",this.layout.height),this.inner_border.attr("x",this.layout.margin.left).attr("y",this.layout.margin.top).attr("width",this.layout.width-(this.layout.margin.left+this.layout.margin.right)).attr("height",this.layout.height-(this.layout.margin.top+this.layout.margin.bottom)),this.layout.inner_border&&this.inner_border.style({"stroke-width":1,stroke:this.layout.inner_border}),this.setTitle(),this.generateExtents();var t=function(t,e){var a=Math.pow(-10,e),i=Math.pow(-10,-e),s=Math.pow(10,-e),n=Math.pow(10,e);return t===1/0&&(t=n),t===-1/0&&(t=a),0===t&&(t=s),0<t&&(t=Math.max(Math.min(t,n),s)),t<0&&(t=Math.max(Math.min(t,i),a)),t},e={};if(this.x_extent){var a={start:0,end:this.layout.cliparea.width};this.layout.axes.x.range&&(a.start=this.layout.axes.x.range.start||a.start,a.end=this.layout.axes.x.range.end||a.end),e.x=[a.start,a.end],e.x_shifted=[a.start,a.end]}if(this.y1_extent){var i={start:this.layout.cliparea.height,end:0};this.layout.axes.y1.range&&(i.start=this.layout.axes.y1.range.start||i.start,i.end=this.layout.axes.y1.range.end||i.end),e.y1=[i.start,i.end],e.y1_shifted=[i.start,i.end]}if(this.y2_extent){var s={start:this.layout.cliparea.height,end:0};this.layout.axes.y2.range&&(s.start=this.layout.axes.y2.range.start||s.start,s.end=this.layout.axes.y2.range.end||s.end),e.y2=[s.start,s.end],e.y2_shifted=[s.start,s.end]}if(this.parent.interaction.panel_id&&(this.parent.interaction.panel_id===this.id||-1!==this.parent.interaction.linked_panel_ids.indexOf(this.id))){var n,o=null;if(this.parent.interaction.zooming&&"function"==typeof this.x_scale){var r=Math.abs(this.x_extent[1]-this.x_extent[0]),l=Math.round(this.x_scale.invert(e.x_shifted[1]))-Math.round(this.x_scale.invert(e.x_shifted[0])),h=this.parent.interaction.zooming.scale,u=Math.floor(l*(1/h));h<1&&!isNaN(this.parent.layout.max_region_scale)?h=1/(Math.min(u,this.parent.layout.max_region_scale)/l):1<h&&!isNaN(this.parent.layout.min_region_scale)&&(h=1/(Math.max(u,this.parent.layout.min_region_scale)/l));var d=Math.floor(r*h),c=(n=this.parent.interaction.zooming.center-this.layout.margin.left-this.layout.origin.x)/this.layout.cliparea.width,p=Math.max(Math.floor(this.x_scale.invert(e.x_shifted[0])-(d-l)*c),1);e.x_shifted=[this.x_scale(p),this.x_scale(p+d)]}else if(this.parent.interaction.dragging)switch(this.parent.interaction.dragging.method){case"background":e.x_shifted[0]=+this.parent.interaction.dragging.dragged_x,e.x_shifted[1]=this.layout.cliparea.width+this.parent.interaction.dragging.dragged_x;break;case"x_tick":g.event&&g.event.shiftKey?(e.x_shifted[0]=+this.parent.interaction.dragging.dragged_x,e.x_shifted[1]=this.layout.cliparea.width+this.parent.interaction.dragging.dragged_x):(o=t((n=this.parent.interaction.dragging.start_x-this.layout.margin.left-this.layout.origin.x)/(n+this.parent.interaction.dragging.dragged_x),3),e.x_shifted[0]=0,e.x_shifted[1]=Math.max(this.layout.cliparea.width*(1/o),1));break;case"y1_tick":case"y2_tick":var y="y"+this.parent.interaction.dragging.method[1]+"_shifted";g.event&&g.event.shiftKey?(e[y][0]=this.layout.cliparea.height+this.parent.interaction.dragging.dragged_y,e[y][1]=+this.parent.interaction.dragging.dragged_y):(o=t((n=this.layout.cliparea.height-(this.parent.interaction.dragging.start_y-this.layout.margin.top-this.layout.origin.y))/(n-this.parent.interaction.dragging.dragged_y),3),e[y][0]=this.layout.cliparea.height,e[y][1]=this.layout.cliparea.height-this.layout.cliparea.height*(1/o))}}if(["x","y1","y2"].forEach(function(t){this[t+"_extent"]&&(this[t+"_scale"]=g.scale.linear().domain(this[t+"_extent"]).range(e[t+"_shifted"]),this[t+"_extent"]=[this[t+"_scale"].invert(e[t][0]),this[t+"_scale"].invert(e[t][1])],this[t+"_scale"]=g.scale.linear().domain(this[t+"_extent"]).range(e[t]),this.renderAxis(t))}.bind(this)),this.layout.interaction.scroll_to_zoom){var _=function(){if(g.event.shiftKey){if(g.event.preventDefault(),this.parent.canInteract(this.id)){var t=g.mouse(this.svg.container.node()),e=Math.max(-1,Math.min(1,g.event.wheelDelta||-g.event.detail||-g.event.deltaY));0!==e&&(this.parent.interaction={panel_id:this.id,linked_panel_ids:this.getLinkedPanelIds("x"),zooming:{scale:e<1?.9:1.1,center:t[0]}},this.render(),this.parent.interaction.linked_panel_ids.forEach(function(t){this.parent.panels[t].render()}.bind(this)),null!==this.zoom_timeout&&clearTimeout(this.zoom_timeout),this.zoom_timeout=setTimeout(function(){this.parent.interaction={},this.parent.applyState({start:this.x_extent[0],end:this.x_extent[1]})}.bind(this),500))}}else this.parent.canInteract(this.id)&&this.loader.show("Press <tt>[SHIFT]</tt> while scrolling to zoom").hide(1e3)}.bind(this);this.zoom_listener=g.behavior.zoom(),this.svg.container.call(this.zoom_listener).on("wheel.zoom",_).on("mousewheel.zoom",_).on("DOMMouseScroll.zoom",_)}return this.data_layer_ids_by_z_index.forEach(function(t){this.data_layers[t].draw().render()}.bind(this)),this},L.Panel.prototype.renderAxis=function(i){if(-1===["x","y1","y2"].indexOf(i))throw new Error("Unable to render axis; invalid axis identifier: "+i);var t=this.layout.axes[i].render&&"function"==typeof this[i+"_scale"]&&!isNaN(this[i+"_scale"](0));if(this[i+"_axis"]&&this.svg.container.select("g.lz-axis.lz-"+i).style("display",t?null:"none"),!t)return this;var e={x:{position:"translate("+this.layout.margin.left+","+(this.layout.height-this.layout.margin.bottom)+")",orientation:"bottom",label_x:this.layout.cliparea.width/2,label_y:this.layout.axes[i].label_offset||0,label_rotate:null},y1:{position:"translate("+this.layout.margin.left+","+this.layout.margin.top+")",orientation:"left",label_x:-1*(this.layout.axes[i].label_offset||0),label_y:this.layout.cliparea.height/2,label_rotate:-90},y2:{position:"translate("+(this.layout.width-this.layout.margin.right)+","+this.layout.margin.top+")",orientation:"right",label_x:this.layout.axes[i].label_offset||0,label_y:this.layout.cliparea.height/2,label_rotate:-90}};this[i+"_ticks"]=this.generateTicks(i);var a=function(t){for(var e=0;e<t.length;e++)if(isNaN(t[e]))return!1;return!0}(this[i+"_ticks"]);if(this[i+"_axis"]=g.svg.axis().scale(this[i+"_scale"]).orient(e[i].orientation).tickPadding(3),a)this[i+"_axis"].tickValues(this[i+"_ticks"]),"region"===this.layout.axes[i].tick_format&&this[i+"_axis"].tickFormat(function(t){return L.positionIntToString(t,6)});else{var s=this[i+"_ticks"].map(function(t){return t[i.substr(0,1)]});this[i+"_axis"].tickValues(s).tickFormat(function(t,e){return this[i+"_ticks"][e].text}.bind(this))}if(this.svg[i+"_axis"].attr("transform",e[i].position).call(this[i+"_axis"]),!a){var n=g.selectAll("g#"+this.getBaseId().replace(".","\\.")+"\\."+i+"_axis g.tick"),o=this;n.each(function(t,e){var a=g.select(this).select("text");o[i+"_ticks"][e].style&&a.style(o[i+"_ticks"][e].style),o[i+"_ticks"][e].transform&&a.attr("transform",o[i+"_ticks"][e].transform)})}var r=this.layout.axes[i].label||null;return null!==r&&(this.svg[i+"_axis_label"].attr("x",e[i].label_x).attr("y",e[i].label_y).text(L.parseFields(this.state,r)),null!==e[i].label_rotate&&this.svg[i+"_axis_label"].attr("transform","rotate("+e[i].label_rotate+" "+e[i].label_x+","+e[i].label_y+")")),["x","y1","y2"].forEach(function(e){if(this.layout.interaction["drag_"+e+"_ticks_to_scale"]){var a="."+this.parent.id+"."+this.id+".interaction.drag",i=function(){"function"==typeof g.select(this).node().focus&&g.select(this).node().focus();var t="x"===e?"ew-resize":"ns-resize";g.event&&g.event.shiftKey&&(t="move"),g.select(this).style({"font-weight":"bold",cursor:t}).on("keydown"+a,i).on("keyup"+a,i)};this.svg.container.selectAll(".lz-axis.lz-"+e+" .tick text").attr("tabindex",0).on("mouseover"+a,i).on("mouseout"+a,function(){g.select(this).style({"font-weight":"normal"}),g.select(this).on("keydown"+a,null).on("keyup"+a,null)}).on("mousedown"+a,function(){this.parent.startDrag(this,e+"_tick")}.bind(this))}}.bind(this)),this},L.Panel.prototype.scaleHeightToData=function(a){null===(a=+a||null)&&this.data_layer_ids_by_z_index.forEach(function(t){var e=this.data_layers[t].getAbsoluteDataHeight();+e&&(a=null===a?+e:Math.max(a,+e))}.bind(this)),+a&&(a+=+this.layout.margin.top+ +this.layout.margin.bottom,this.setDimensions(this.layout.width,a),this.parent.setDimensions(),this.parent.panel_ids_by_y_index.forEach(function(t){this.parent.panels[t].layout.proportional_height=null}.bind(this)),this.parent.positionPanels())},L.Panel.prototype.setElementStatusByFilters=function(e,a,i,s){this.data_layer_ids_by_z_index.forEach(function(t){this.data_layers[t].setElementStatusByFilters(e,a,i,s)}.bind(this))},L.Panel.prototype.setAllElementStatus=function(e,a){this.data_layer_ids_by_z_index.forEach(function(t){this.data_layers[t].setAllElementStatus(e,a)}.bind(this))},L.DataLayer.Statuses.verbs.forEach(function(t,e){var a=L.DataLayer.Statuses.adjectives[e],i="un"+t;L.Panel.prototype[t+"ElementsByFilters"]=function(t,e){return e=void 0!==e&&!!e,this.setElementStatusByFilters(a,!0,t,e)},L.Panel.prototype[i+"ElementsByFilters"]=function(t,e){return e=void 0!==e&&!!e,this.setElementStatusByFilters(a,!1,t,e)},L.Panel.prototype[t+"AllElements"]=function(){return this.setAllElementStatus(a,!0),this},L.Panel.prototype[i+"AllElements"]=function(){return this.setAllElementStatus(a,!1),this}}),L.Panel.prototype.addBasicLoader=function(t){return void 0!==t&&(t=!0),t&&this.loader.show("Loading...").animate(),this.on("data_requested",function(){this.loader.show("Loading...").animate()}.bind(this)),this.on("data_rendered",function(){this.loader.hide()}.bind(this)),this}}catch(t){console.error("LocusZoom Plugin error: ",t)}return L},"function"==typeof define&&define.amd?define(["d3"],function(t){return e.LocusZoom=a(t)}):"object"==typeof module&&module.exports?module.exports=e.LocusZoom=a(require("d3")):e.LocusZoom=a(e.d3)}catch(t){console.error("LocusZoom Plugin error: ",t)}return LocusZoom});
//# sourceMappingURL=locuszoom.app.min.js.map
